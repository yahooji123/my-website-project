<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital Bank + UPI Simulator (HTML, CSS & JavaScript)</title>
  <style>
    :root{
      --bg:#0b1220;         /* deep blue */
      --card:#121a2b;       /* card surface */
      --muted:#7f8aa3;      /* secondary text */
      --text:#e9eefc;       /* primary text */
      --accent:#4f7cff;     /* buttons / links */
      --accent-2:#22c55e;   /* success */
      --danger:#ef4444;     /* danger */
      --warn:#f59e0b;       /* warn */
      --shadow: 0 15px 40px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, #1b2340 0%, transparent 60%),
                  radial-gradient(900px 400px at 120% 10%, #13224a 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position: sticky; top:0; z-index:2;
      backdrop-filter: blur(10px);
      background: linear-gradient(0deg, rgba(18,26,43,.7), rgba(18,26,43,.7));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .nav{
      max-width:1100px; margin:0 auto; padding:14px 20px; display:flex; gap:16px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:800; letter-spacing:.3px}
    .brand .logo{width:40px; height:40px; border-radius:12px; display:grid; place-items:center; background:linear-gradient(135deg,#4f7cff, #22c55e); box-shadow: var(--shadow)}
    .brand .logo span{font-weight:900}
    .tabs{display:flex; gap:8px; flex-wrap:wrap}
    .tab-btn{
      background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.12);
      padding:10px 14px; border-radius:12px; cursor:pointer; transition:.2s; font-weight:600
    }
    .tab-btn.active, .tab-btn:hover{ background: rgba(79,124,255,.18); border-color: rgba(79,124,255,.55)}

    main{max-width:1100px; margin:22px auto 60px; padding:0 20px;}
    .grid{display:grid; grid-template-columns: 1.1fr .9fr; gap:20px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }

    .card{background:linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.04)); border:1px solid rgba(255,255,255,.08);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden}
    .card header{position:initial; background:transparent; border:0}
    .card-title{padding:18px 18px 0; font-size:20px; font-weight:800}
    .card-sub{padding:0 18px 8px; color:var(--muted); font-size:13px}
    .card-body{padding:18px}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 720px){ .row{grid-template-columns:1fr} }

    label{font-size:12px; color:var(--muted); margin:10px 4px 6px; display:block}
    input, select, textarea{
      width:100%; padding:12px 12px; background:#0d1526; color:var(--text);
      border:1px solid rgba(255,255,255,.12); border-radius:12px; outline:none; transition:.2s;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--accent)}

    .btn{display:inline-flex; align-items:center; gap:10px; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0d1526; color:var(--text); cursor:pointer; transition:.2s; font-weight:700}
    .btn.primary{ background: linear-gradient(135deg, #4f7cff, #22c55e); border:0; color:white }
    .btn.ghost{ background: transparent}
    .btn.warn{ background: linear-gradient(135deg, #f59e0b, #ef4444); color:#1b0d0d; border:0 }
    .btn:disabled{ opacity:.65; cursor:not-allowed }

    .stack{display:flex; flex-wrap:wrap; gap:10px}
    .muted{color:var(--muted)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}

    .divider{height:1px; background: rgba(255,255,255,.08); margin:18px 0}

    .stat{
      background: linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.08);
      padding:12px 14px; border-radius:14px; display:flex; align-items:center; justify-content:space-between
    }

    .good{color:var(--accent-2)}
    .bad{color:var(--danger)}
    .chip{display:inline-flex; align-items:center; gap:8px; background: rgba(79,124,255,.16); padding:6px 10px; border-radius:999px; font-size:12px; border:1px solid rgba(79,124,255,.42)}

    table{width:100%; border-collapse: collapse;}
    th, td{ text-align:left; padding:10px 12px; border-bottom: 1px dashed rgba(255,255,255,.08)}
    th{ font-size:12px; color:var(--muted); font-weight:700; letter-spacing:.2px }
    .right{text-align:right}

    .footer{max-width:1100px; margin:28px auto 60px; padding:0 20px; color:var(--muted); font-size:13px}
    .kbd{border:1px solid rgba(255,255,255,.18); background:#0d1526; padding:2px 6px; border-radius:6px}
    
    /* New UPI styles */
    .upi-container { display: flex; gap: 20px; margin-top: 20px; }
    .upi-section { flex: 1; }
    .qr-code { 
      background: white; padding: 15px; border-radius: 12px; 
      display: inline-block; margin-top: 10px; text-align: center;
    }
    .qr-code img { width: 180px; height: 180px; }
    .upi-id { font-family: monospace; background: rgba(79,124,255,.1); padding: 8px 12px; border-radius: 8px; }
    .phone-simulator {
      background: #f0f0f0; border-radius: 24px; padding: 20px; width: 300px; margin: 0 auto;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2); color: #333;
    }
    .phone-header { text-align: center; margin-bottom: 15px; font-weight: bold; }
    .phone-screen {
      background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px;
      height: 400px; overflow-y: auto;
    }
    .phone-btn {
      background: #4f7cff; color: white; border: none; padding: 10px; border-radius: 8px;
      width: 100%; margin-top: 10px; font-weight: bold;
    }
    .transaction-item {
      padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;
    }
    .pending { opacity: 0.7; font-style: italic; }
    .success { color: var(--accent-2); }
    .failed { color: var(--danger); }
    .amount { font-weight: bold; }
    
    /* Animation */
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .pulse { animation: pulse 2s infinite; }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 100;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: var(--card);
      border-radius: var(--radius);
      padding: 20px;
      width: 90%;
      max-width: 500px;
      border: 1px solid rgba(255,255,255,.1);
      box-shadow: var(--shadow);
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .modal-title {
      font-size: 18px;
      font-weight: bold;
    }
    .close-modal {
      background: none;
      border: none;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
    }
    .modal-body {
      margin-bottom: 20px;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    /* Security questions */
    .security-questions {
      display: none;
      margin-top: 15px;
    }
    .security-question {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <header>
    <div class="nav">
      <div class="brand">
        <div class="logo" aria-hidden="true"><span>‚Çπ</span></div>
        <div>
          <div style="font-size:14px; color:var(--muted); font-weight:700; letter-spacing:1.4px; text-transform:uppercase">Digital Banking</div>
          <div style="font-size:18px; font-weight:900">Bank + UPI Simulator</div>
        </div>
      </div>
      <div class="tabs">
        <button class="tab-btn active" data-tab="bank">üè¶ Bank Portal</button>
        <button class="tab-btn" data-tab="atm">üèß ATM</button>
        <button class="tab-btn" data-tab="upi">üì± UPI Payments</button>
        <button class="tab-btn" data-tab="about">‚ÑπÔ∏è Guide</button>
      </div>
    </div>
  </header>

  <main>
    <section id="bank" class="card">
      <div class="card-title">üè¶ Digital Banking Portal</div>
      <div class="card-sub">Account management, transactions, transfers, and statements. (Demo only - no real money!)</div>
      <div class="card-body">
        <div class="row">
          <div class="card">
            <div class="card-title">üÜï New Account</div>
            <div class="card-sub">Create account with name, phone and 4-digit PIN.</div>
            <div class="card-body">
              <div class="row">
                <div>
                  <label>Full Name</label>
                  <input id="regName" placeholder="Anurag Rastogi" />
                </div>
                <div>
                  <label>Phone</label>
                  <input id="regPhone" placeholder="98765 43210" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Set 4-digit PIN</label>
                  <input id="regPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
                </div>
                <div>
                  <label>Confirm PIN</label>
                  <input id="regPINConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
                </div>
              </div>
              <div class="row" style="margin-top:12px">
                <div>
                  <label>Security Question 1</label>
                  <select id="securityQuestion1">
                    <option value="">Select a question</option>
                    <option value="What was your first pet's name?">What was your first pet's name?</option>
                    <option value="What city were you born in?">What city were you born in?</option>
                    <option value="What is your mother's maiden name?">What is your mother's maiden name?</option>
                  </select>
                  <input id="securityAnswer1" placeholder="Your answer" style="margin-top:6px; display:none" />
                </div>
                <div>
                  <label>Security Question 2</label>
                  <select id="securityQuestion2">
                    <option value="">Select a question</option>
                    <option value="What was your childhood nickname?">What was your childhood nickname?</option>
                    <option value="What was the name of your first school?">What was the name of your first school?</option>
                    <option value="What is your favorite movie?">What is your favorite movie?</option>
                  </select>
                  <input id="securityAnswer2" placeholder="Your answer" style="margin-top:6px; display:none" />
                </div>
              </div>
              <div style="margin-top:12px">
                <button id="btnOpenAccount" class="btn primary" style="width:100%">Create Account</button>
              </div>
              <div id="regOut" class="muted" style="margin-top:8px"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">üîê Login</div>
            <div class="card-sub">Login with Account No. and PIN.</div>
            <div class="card-body">
              <div class="row">
                <div>
                  <label>Account Number</label>
                  <input id="loginAcc" placeholder="e.g., 1002003001" />
                </div>
                <div>
                  <label>PIN</label>
                  <input id="loginPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
                </div>
              </div>
              <div class="stack" style="margin-top:12px">
                <button id="btnLogin" class="btn primary">Login</button>
                <button id="btnLogout" class="btn ghost">Logout</button>
                <button id="btnForgotPIN" class="btn ghost">Forgot PIN?</button>
                <span id="loginMsg" class="chip" style="display:none"></span>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="card">
            <div class="card-title">üí∞ Deposit / Withdraw</div>
            <div class="card-body">
              <div class="row">
                <div>
                  <label>Amount (‚Çπ)</label>
                  <input id="txnAmount" placeholder="500" inputmode="numeric" />
                </div>
                <div>
                  <label>Action</label>
                  <select id="txnType">
                    <option value="deposit">Deposit</option>
                    <option value="withdraw">Withdraw</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Narration (optional)</label>
                  <input id="txnNote" placeholder="Cash / Salary / ATM withdraw..." />
                </div>
                <div style="display:flex; align-items:flex-end">
                  <button id="btnDoTxn" class="btn primary" style="width:100%">Submit</button>
                </div>
              </div>
              <div id="txnOut" class="muted" style="margin-top:8px"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">üîÅ Bank Transfer</div>
            <div class="card-body">
              <div class="row">
                <div>
                  <label>To Account No.</label>
                  <input id="toAcc" placeholder="Receiver account" />
                </div>
                <div>
                  <label>Amount (‚Çπ)</label>
                  <input id="toAmt" placeholder="250" inputmode="numeric" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label>Your PIN</label>
                  <input id="toPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
                </div>
                <div style="display:flex; align-items:flex-end">
                  <button id="btnTransfer" class="btn primary" style="width:100%">Transfer</button>
                </div>
              </div>
              <div id="transferOut" class="muted" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row">
          <div class="card">
            <div class="card-title">üìä Account Summary</div>
            <div class="card-body">
              <div class="row">
                <div class="stat"><span>Holder</span><strong id="sumName">‚Äî</strong></div>
                <div class="stat"><span>Account No.</span><strong class="mono" id="sumAcc">‚Äî</strong></div>
              </div>
              <div class="row" style="margin-top:12px">
                <div class="stat"><span>Balance</span><strong id="sumBal">‚Çπ0.00</strong></div>
                <div class="stat"><span>Last Updated</span><span class="muted" id="sumTime">‚Äî</span></div>
              </div>
              <div class="row" style="margin-top:12px">
                <div class="stat"><span>UPI ID</span><strong id="sumUpi">‚Äî</strong></div>
                <div class="stat"><span>Mobile</span><strong id="sumPhone">‚Äî</strong></div>
              </div>
              <div class="stack" style="margin-top:12px">
                <button id="btnChangePIN" class="btn ghost">Change PIN</button>
                <button id="btnChangeUPIPIN" class="btn ghost">Change UPI PIN</button>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">üßæ Statement (Last 10)</div>
            <div class="card-body">
              <table>
                <thead>
                  <tr>
                    <th>Date/Time</th>
                    <th>Type</th>
                    <th>Narration</th>
                    <th class="right">Amount</th>
                    <th class="right">Balance</th>
                  </tr>
                </thead>
                <tbody id="stmtBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="atm" class="card" style="display:none">
      <div class="card-title">üèß ATM Simulator</div>
      <div class="card-sub">Insert card ‚Üí PIN verify ‚Üí Withdraw / Balance / Mini statement.</div>
      <div class="card-body">
        <div class="row">
          <div class="card">
            <div class="card-title">üí≥ Insert Card</div>
            <div class="card-body">
              <label>Select Account (as card)</label>
              <select id="atmCard"></select>
              <div class="row" style="margin-top:12px">
                <div>
                  <label>Enter PIN</label>
                  <input id="atmPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
                </div>
                <div style="display:flex; align-items:flex-end">
                  <button id="btnAtmEnter" class="btn primary" style="width:100%">Enter</button>
                </div>
              </div>
              <div id="atmAuthMsg" class="muted" style="margin-top:8px"></div>
              <button id="btnAtmForgotPIN" class="btn ghost" style="width:100%; margin-top:8px">Forgot PIN?</button>
            </div>
          </div>

          <div class="card">
            <div class="card-title">üèß ATM Screen</div>
            <div class="card-body">
              <div class="row">
                <div class="stat"><span>Active Card</span><strong class="mono" id="atmActive">‚Äî</strong></div>
                <div class="stat"><span>Status</span><strong id="atmStatus">Insert card</strong></div>
              </div>
              <div class="row" style="margin-top:12px">
                <div>
                  <label>Amount (‚Çπ) to Withdraw</label>
                  <input id="atmAmt" placeholder="400" inputmode="numeric" />
                </div>
                <div style="display:flex; align-items:flex-end">
                  <button id="btnAtmWithdraw" class="btn primary" style="width:100%">Withdraw</button>
                </div>
              </div>
              <div class="stack" style="margin-top:10px">
                <button id="btnAtmBal" class="btn">Balance</button>
                <button id="btnAtmMini" class="btn">Mini Statement (5)</button>
                <button id="btnAtmEject" class="btn warn">Eject Card</button>
              </div>
              <div id="atmOut" class="muted" style="margin-top:8px"></div>
              <div class="divider"></div>
              <table>
                <thead>
                  <tr>
                    <th>Date/Time</th>
                    <th>Type</th>
                    <th>Narration</th>
                    <th class="right">Amount</th>
                    <th class="right">Balance</th>
                  </tr>
                </thead>
                <tbody id="atmStmtBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="upi" class="card" style="display:none">
      <div class="card-title">üì± UPI Payments</div>
      <div class="card-sub">Send/receive money via UPI ID, QR code, or phone number</div>
      <div class="card-body">
        <div class="row">
          <div class="card">
            <div class="card-title">üí∏ Send Money</div>
            <div class="card-body">
              <div class="row">
                <div>
                  <label>Recipient UPI ID</label>
                  <input id="upiTo" placeholder="name@bank" />
                </div>
                <div>
                  <label>Amount (‚Çπ)</label>
                  <input id="upiAmt" placeholder="100" inputmode="numeric" />
                </div>
              </div>
              <div>
                <label>Purpose (optional)</label>
                  <input id="upiNote" placeholder="Dinner, Rent, Shopping..." />
              </div>
              <div class="row" style="margin-top:12px">
                <div>
                  <label>Your UPI PIN</label>
                  <input id="upiPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" type="password" />
                </div>
                <div style="display:flex; align-items:flex-end">
                  <button id="btnUpiSend" class="btn primary" style="width:100%">Send Money</button>
                </div>
              </div>
              <div id="upiOut" class="muted" style="margin-top:8px"></div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">üì≤ Request Money</div>
            <div class="card-body">
              <div class="row">
                <div>
                  <label>Request From UPI ID</label>
                  <input id="upiFrom" placeholder="friend@bank" />
                </div>
                <div>
                  <label>Amount (‚Çπ)</label>
                  <input id="upiReqAmt" placeholder="100" inputmode="numeric" />
                </div>
              </div>
              <div>
                <label>Purpose (optional)</label>
                  <input id="upiReqNote" placeholder="Dinner, Rent, Shopping..." />
              </div>
              <div style="margin-top:12px">
                <button id="btnUpiRequest" class="btn primary" style="width:100%">Request Payment</button>
              </div>
              <div id="upiReqOut" class="muted" style="margin-top:8px"></div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="upi-container">
          <div class="upi-section">
            <div class="card">
              <div class="card-title">üì≥ Your UPI QR Code</div>
              <div class="card-body">
                <div id="upiQrContainer">
                  <p>Login to view your UPI QR code</p>
                </div>
                <div style="margin-top:12px">
                  <label>Your UPI ID</label>
                  <div id="upiIdDisplay" class="upi-id">Not logged in</div>
                </div>
                <div style="margin-top:12px">
                  <button id="btnRefreshQr" class="btn ghost">Refresh QR</button>
                  <button id="btnChangeUPIPIN" class="btn ghost">Change UPI PIN</button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="upi-section">
            <div class="card">
              <div class="card-title">üì± Phone Simulator</div>
              <div class="card-body">
                <div class="phone-simulator">
                  <div class="phone-header">UPI Payment App</div>
                  <div class="phone-screen" id="phoneScreen">
                    <p>Scan a QR code or enter UPI details to make payment</p>
                  </div>
                  <div>
                    <button class="phone-btn" id="btnScanQr">Scan QR Code</button>
                    <button class="phone-btn" id="btnPayContact">Pay to Contact</button>
                    <button class="phone-btn" id="btnForgotUPIPIN" style="background:var(--warn); margin-top:15px">Forgot UPI PIN</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="card">
          <div class="card-title">üìú UPI Transaction History</div>
          <div class="card-body">
            <table>
              <thead>
                <tr>
                  <th>Date/Time</th>
                  <th>Type</th>
                  <th>UPI ID</th>
                  <th>Note</th>
                  <th class="right">Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="upiHistoryBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section id="about" class="card" style="display:none">
      <div class="card-title">‚ÑπÔ∏è Guide & Features</div>
      <div class="card-body">
        <h3>üåü New Features Added:</h3>
        <ul>
          <li><strong>Forgot PIN Recovery</strong> - Reset your account PIN using security questions</li>
          <li><strong>UPI PIN Management</strong> - Change or reset your UPI PIN</li>
          <li><strong>Enhanced Security</strong> - Security questions during account creation</li>
          <li><strong>PIN Confirmation</strong> - Verify PIN during account creation</li>
          <li><strong>Password Fields</strong> - PIN inputs now masked for security</li>
          <li><strong>UPI Payments</strong> - Send/receive money via UPI ID or QR codes</li>
          <li><strong>Smartphone Simulator</strong> - Simulate UPI app for realistic payments</li>
        </ul>
        
        <h3>üîê How to Reset Your PIN:</h3>
        <ol>
          <li>Click "Forgot PIN?" on login page</li>
          <li>Enter your account number</li>
          <li>Answer your security questions</li>
          <li>Set a new 4-digit PIN</li>
          <li>Login with your new PIN</li>
        </ol>
        
        <h3>üì± How to Use UPI Features:</h3>
        <ol>
          <li>Create an account and login</li>
          <li>Go to the UPI Payments tab</li>
          <li>Send money by entering recipient UPI ID and amount</li>
          <li>Request payments from other users</li>
          <li>Use the phone simulator to scan QR codes</li>
          <li>Check UPI transaction history for all records</li>
        </ol>
        
        <h3>üîí Security Notes:</h3>
        <ul>
          <li>This is a <strong>demo simulator</strong> - no real money is used</li>
          <li>All data is stored in your browser's localStorage</li>
          <li>UPI PIN is different from your account PIN</li>
          <li>QR codes contain payment information but no sensitive data</li>
          <li>Security questions help recover your account if you forget PIN</li>
        </ul>
        
        <p class="muted">Tip: Use <span class="kbd">Ctrl</span> + <span class="kbd">S</span> to save this page for offline use. Works on mobile too!</p>
      </div>
    </section>
  </main>

  <!-- Forgot PIN Modal -->
  <div id="forgotPINModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üîí Reset Your PIN</div>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="forgotPINStep1">
          <p>Enter your account number to begin PIN recovery:</p>
          <input id="forgotPINAcc" placeholder="Account Number" style="width:100%; margin-bottom:10px" />
          <div id="forgotPINError" class="muted" style="color:var(--danger); margin-bottom:10px"></div>
        </div>
        <div id="forgotPINStep2" style="display:none">
          <p>Answer your security questions to verify your identity:</p>
          <div id="securityQuestionsContainer"></div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>New 4-digit PIN</label>
              <input id="newPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
            </div>
            <div>
              <label>Confirm New PIN</label>
              <input id="newPINConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
            </div>
          </div>
          <div id="forgotPINSuccess" class="muted" style="color:var(--accent-2); margin-top:10px; display:none"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelForgotPIN" class="btn ghost">Cancel</button>
        <button id="btnNextForgotPIN" class="btn primary">Next</button>
        <button id="btnResetPIN" class="btn primary" style="display:none">Reset PIN</button>
      </div>
    </div>
  </div>
  
  <!-- Change PIN Modal -->
  <div id="changePINModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üîí Change Your PIN</div>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>Current PIN</label>
            <input id="currentPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
          </div>
          <div>
            <label>New 4-digit PIN</label>
            <input id="changeNewPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Confirm New PIN</label>
            <input id="changeNewPINConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
          </div>
          <div>
            <label>Your UPI PIN (for verification)</label>
            <input id="changeUPIPINVerify" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" type="password" />
          </div>
        </div>
        <div id="changePINError" class="muted" style="color:var(--danger); margin-top:10px"></div>
        <div id="changePINSuccess" class="muted" style="color:var(--accent-2); margin-top:10px; display:none"></div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelChangePIN" class="btn ghost">Cancel</button>
        <button id="btnSubmitChangePIN" class="btn primary">Change PIN</button>
      </div>
    </div>
  </div>
  
  <!-- Change UPI PIN Modal -->
  <div id="changeUPIPINModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üîí Change Your UPI PIN</div>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div>
            <label>Current UPI PIN</label>
            <input id="currentUPIPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" type="password" />
          </div>
          <div>
            <label>New 6-digit UPI PIN</label>
            <input id="newUPIPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" type="password" />
          </div>
        </div>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Confirm New UPI PIN</label>
            <input id="newUPIPINConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" type="password" />
          </div>
          <div>
            <label>Your Account PIN (for verification)</label>
            <input id="changeUPIPINAccountPIN" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="4" inputmode="numeric" type="password" />
          </div>
        </div>
        <div id="changeUPIPINError" class="muted" style="color:var(--danger); margin-top:10px"></div>
        <div id="changeUPIPINSuccess" class="muted" style="color:var(--accent-2); margin-top:10px; display:none"></div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelChangeUPIPIN" class="btn ghost">Cancel</button>
        <button id="btnSubmitChangeUPIPIN" class="btn primary">Change UPI PIN</button>
      </div>
    </div>
  </div>
  
  <!-- Forgot UPI PIN Modal -->
  <div id="forgotUPIPINModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">üîí Reset Your UPI PIN</div>
        <button class="close-modal">&times;</button>
      </div>
      <div class="modal-body">
        <div id="forgotUPIPINStep1">
          <p>Enter your account number to begin UPI PIN recovery:</p>
          <input id="forgotUPIPINAcc" placeholder="Account Number" style="width:100%; margin-bottom:10px" />
          <div id="forgotUPIPINError" class="muted" style="color:var(--danger); margin-bottom:10px"></div>
        </div>
        <div id="forgotUPIPINStep2" style="display:none">
          <p>Answer your security questions to verify your identity:</p>
          <div id="upiSecurityQuestionsContainer"></div>
          <div class="row" style="margin-top:10px">
            <div>
              <label>New 6-digit UPI PIN</label>
              <input id="newUPIPINReset" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" type="password" />
            </div>
            <div>
              <label>Confirm New UPI PIN</label>
              <input id="newUPIPINResetConfirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="6" inputmode="numeric" type="password" />
            </div>
          </div>
          <div id="forgotUPIPINSuccess" class="muted" style="color:var(--accent-2); margin-top:10px; display:none"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btnCancelForgotUPIPIN" class="btn ghost">Cancel</button>
        <button id="btnNextForgotUPIPIN" class="btn primary">Next</button>
        <button id="btnResetUPIPIN" class="btn primary" style="display:none">Reset UPI PIN</button>
      </div>
    </div>
  </div>

  <div class="footer">Digital Banking Simulator with UPI Payments - For educational purposes only. ¬© 2025</div>

  <script>
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Minimal in-browser "database" using localStorage
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    const DB_KEY = 'bankDB_v3'; // Updated for security features
    const nowISO = () => new Date().toISOString();

    const DB = {
      load(){
        try { 
          const data = JSON.parse(localStorage.getItem(DB_KEY)) || { 
            seq: 1002003000, 
            users: {}, 
            sessions: {},
            upiTxns: {}
          };
          
          // Initialize UPI IDs and security questions for existing accounts if needed
          for(const acc in data.users) {
            if(!data.users[acc].upiId) {
              const phone = data.users[acc].phone.replace(/\D/g,'').slice(-10);
              data.users[acc].upiId = `${data.users[acc].name.toLowerCase().replace(/\s/g,'')}${phone}@virtualbank`;
              data.users[acc].upiPin = '123456'; // Default UPI PIN for demo
            }
            if(!data.users[acc].securityQuestions) {
              data.users[acc].securityQuestions = [
                { question: "What was your first pet's name?", answer: "demo" },
                { question: "What city were you born in?", answer: "demo" }
              ];
            }
          }
          
          return data;
        } catch { 
          return { 
            seq: 1002003000, 
            users: {}, 
            sessions: {},
            upiTxns: {}
          }; 
        }
      },
      save(data){ localStorage.setItem(DB_KEY, JSON.stringify(data)); },
      createUser(name, phone, pin, securityQuestions){
        const db = this.load();
        if(!/^\d{4}$/.test(pin)) throw new Error('PIN must be exactly 4 digits');
        const acc = (++db.seq).toString();
        const cleanPhone = phone.replace(/\D/g,'').slice(-10);
        const upiId = `${name.toLowerCase().replace(/\s/g,'')}${cleanPhone}@virtualbank`;
        
        db.users[acc] = { 
          acc, 
          name, 
          phone: cleanPhone, 
          pin, 
          upiId,
          upiPin: '123456', // Default UPI PIN for demo
          balance: 0, 
          createdAt: nowISO(), 
          updatedAt: nowISO(), 
          txns: [],
          securityQuestions: securityQuestions || [
            { question: "What was your first pet's name?", answer: "demo" },
            { question: "What city were you born in?", answer: "demo" }
          ]
        };
        this.save(db); 
        return db.users[acc];
      },
      getUser(acc){ const db = this.load(); return db.users[acc] || null },
      allUsers(){ const db = this.load(); return Object.values(db.users) },
      verify(acc, pin){ const u = this.getUser(acc); return !!(u && u.pin === pin) },
      verifyUpiPin(acc, upiPin){ const u = this.getUser(acc); return !!(u && u.upiPin === upiPin) },
      verifySecurityQuestions(acc, answers) {
        const u = this.getUser(acc);
        if(!u) return false;
        
        // Check if at least one answer matches
        for(const q of u.securityQuestions) {
          if(answers.some(a => a.question === q.question && a.answer.toLowerCase() === q.answer.toLowerCase())) {
            return true;
          }
        }
        return false;
      },
      resetPIN(acc, newPIN) {
        const db = this.load();
        const u = db.users[acc];
        if(!u) throw new Error('Account not found');
        if(!/^\d{4}$/.test(newPIN)) throw new Error('PIN must be exactly 4 digits');
        
        u.pin = newPIN;
        u.updatedAt = nowISO();
        db.users[acc] = u;
        this.save(db);
        return true;
      },
      resetUPIPIN(acc, newUPIPIN) {
        const db = this.load();
        const u = db.users[acc];
        if(!u) throw new Error('Account not found');
        if(!/^\d{6}$/.test(newUPIPIN)) throw new Error('UPI PIN must be exactly 6 digits');
        
        u.upiPin = newUPIPIN;
        u.updatedAt = nowISO();
        db.users[acc] = u;
        this.save(db);
        return true;
      },
      changePIN(acc, currentPIN, newPIN) {
        const db = this.load();
        const u = db.users[acc];
        if(!u) throw new Error('Account not found');
        if(u.pin !== currentPIN) throw new Error('Current PIN is incorrect');
        if(!/^\d{4}$/.test(newPIN)) throw new Error('New PIN must be exactly 4 digits');
        
        u.pin = newPIN;
        u.updatedAt = nowISO();
        db.users[acc] = u;
        this.save(db);
        return true;
      },
      changeUPIPIN(acc, currentUPIPIN, newUPIPIN) {
        const db = this.load();
        const u = db.users[acc];
        if(!u) throw new Error('Account not found');
        if(u.upiPin !== currentUPIPIN) throw new Error('Current UPI PIN is incorrect');
        if(!/^\d{6}$/.test(newUPIPIN)) throw new Error('New UPI PIN must be exactly 6 digits');
        
        u.upiPin = newUPIPIN;
        u.updatedAt = nowISO();
        db.users[acc] = u;
        this.save(db);
        return true;
      },
      postTxn(acc, type, amount, note){
        const db = this.load();
        const u = db.users[acc]; if(!u) throw new Error('Account not found');
        if(amount <= 0 || !Number.isFinite(amount)) throw new Error('Invalid amount');
        if(type === 'deposit') u.balance += amount;
        else if(type === 'withdraw'){ if(u.balance < amount) throw new Error('Insufficient funds'); u.balance -= amount; }
        else throw new Error('Invalid txn type');
        const txn = { id: crypto.randomUUID(), ts: nowISO(), type, amount, note: note||'', postBal: u.balance };
        u.txns.unshift(txn); // newest first
        u.updatedAt = nowISO();
        db.users[acc] = u; this.save(db); return txn;
      },
      transfer(fromAcc, toAcc, amount){
        if(fromAcc === toAcc) throw new Error('Cannot transfer to same account');
        const db = this.load();
        const from = db.users[fromAcc]; const to = db.users[toAcc];
        if(!from || !to) throw new Error('Invalid account number');
        if(amount <= 0 || !Number.isFinite(amount)) throw new Error('Invalid amount');
        if(from.balance < amount) throw new Error('Insufficient funds');
        from.balance -= amount; to.balance += amount;
        const t1 = { id: crypto.randomUUID(), ts: nowISO(), type: 'transfer-out', amount, note: `To ${toAcc}`, postBal: from.balance };
        const t2 = { id: crypto.randomUUID(), ts: nowISO(), type: 'transfer-in', amount, note: `From ${fromAcc}`, postBal: to.balance };
        from.txns.unshift(t1); to.txns.unshift(t2);
        from.updatedAt = to.updatedAt = nowISO();
        db.users[fromAcc] = from; db.users[toAcc] = to; this.save(db);
        return { from: t1, to: t2 };
      },
      upiTransfer(fromAcc, toUpiId, amount, note) {
        const db = this.load();
        const from = db.users[fromAcc];
        if(!from) throw new Error('Sender account not found');
        
        // Find recipient by UPI ID
        let to = null;
        for(const acc in db.users) {
          if(db.users[acc].upiId === toUpiId) {
            to = db.users[acc];
            break;
          }
        }
        if(!to) throw new Error('Recipient UPI ID not found');
        if(fromAcc === to.acc) throw new Error('Cannot send to yourself');
        if(amount <= 0 || !Number.isFinite(amount)) throw new Error('Invalid amount');
        if(from.balance < amount) throw new Error('Insufficient funds');
        
        // Perform transfer
        from.balance -= amount;
        to.balance += amount;
        
        // Create transactions
        const t1 = { 
          id: crypto.randomUUID(), 
          ts: nowISO(), 
          type: 'upi-send', 
          amount, 
          note: note || `UPI to ${toUpiId}`,
          postBal: from.balance 
        };
        
        const t2 = { 
          id: crypto.randomUUID(), 
          ts: nowISO(), 
          type: 'upi-receive', 
          amount, 
          note: note || `UPI from ${from.upiId}`,
          postBal: to.balance 
        };
        
        from.txns.unshift(t1); 
        to.txns.unshift(t2);
        from.updatedAt = to.updatedAt = nowISO();
        
        // Record UPI transaction
        const upiTxnId = `upi-${crypto.randomUUID()}`;
        db.upiTxns[upiTxnId] = {
          id: upiTxnId,
          from: from.acc,
          fromUpi: from.upiId,
          to: to.acc,
          toUpi: to.upiId,
          amount,
          note: note || '',
          status: 'success',
          ts: nowISO()
        };
        
        db.users[fromAcc] = from; 
        db.users[to.acc] = to; 
        this.save(db);
        
        return { 
          txn: upiTxnId,
          from: t1, 
          to: t2,
          upiRecord: db.upiTxns[upiTxnId]
        };
      },
      requestUpiPayment(fromUpiId, toAcc, amount, note) {
        const db = this.load();
        const to = db.users[toAcc];
        if(!to) throw new Error('Recipient account not found');
        
        // Find requester by UPI ID
        let from = null;
        for(const acc in db.users) {
          if(db.users[acc].upiId === fromUpiId) {
            from = db.users[acc];
            break;
          }
        }
        if(!from) throw new Error('Requester UPI ID not found');
        if(from.acc === toAcc) throw new Error('Cannot request from yourself');
        if(amount <= 0 || !Number.isFinite(amount)) throw new Error('Invalid amount');
        
        // Record UPI request (not completed yet)
        const upiTxnId = `upi-req-${crypto.randomUUID()}`;
        db.upiTxns[upiTxnId] = {
          id: upiTxnId,
          from: from.acc,
          fromUpi: from.upiId,
          to: to.acc,
          toUpi: to.upiId,
          amount,
          note: note || '',
          status: 'pending',
          ts: nowISO()
        };
        
        this.save(db);
        return db.upiTxns[upiTxnId];
      },
      getUserUpiTxns(acc) {
        const db = this.load();
        const upiId = db.users[acc]?.upiId;
        if(!upiId) return [];
        
        return Object.values(db.upiTxns).filter(txn => 
          txn.from === acc || txn.to === acc
        ).sort((a,b) => new Date(b.ts) - new Date(a.ts));
      }
    };

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // UI Helpers
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const fmt = (n) => `‚Çπ${(n||0).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`;
    const human = (iso) => new Date(iso).toLocaleString();

    function toast(el, msg, color){ el.textContent = msg; el.style.color = color || 'var(--muted)'; }
    
    // Modal functions
    function showModal(id) {
      $(id).style.display = 'flex';
    }
    
    function hideModal(id) {
      $(id).style.display = 'none';
    }
    
    function resetModal(id) {
      $(id).querySelectorAll('input').forEach(input => {
        input.value = '';
      });
      $(id).querySelectorAll('.muted').forEach(el => {
        el.style.display = 'none';
      });
    }
    
    // Close modals when clicking outside
    $$('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if(e.target === modal) {
          hideModal(`#${modal.id}`);
          resetModal(`#${modal.id}`);
        }
      });
    });
    
    // Close modals with close button
    $$('.close-modal').forEach(btn => {
      btn.addEventListener('click', () => {
        const modal = btn.closest('.modal');
        hideModal(`#${modal.id}`);
        resetModal(`#${modal.id}`);
      });
    });

    // Tabs
    document.querySelectorAll('.tab-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        ['bank','atm','upi','about'].forEach(id=>{ document.getElementById(id).style.display = (id===tab)?'block':'none'; });
        if(tab==='atm') refreshATMCardList();
        if(tab==='upi' && currentAcc) {
          generateUpiQrCode();
          refreshUpiHistory();
        }
      })
    })

    // Session state (simple)
    let currentAcc = null;  // logged-in account for Bank portal

    function refreshSummary(){
      const u = currentAcc ? DB.getUser(currentAcc) : null;
      $('#sumName').textContent = u? u.name : '‚Äî';
      $('#sumAcc').textContent = u? u.acc : '‚Äî';
      $('#sumBal').textContent = fmt(u? u.balance : 0);
      $('#sumTime').textContent = u? human(u.updatedAt) : '‚Äî';
      $('#sumUpi').textContent = u? u.upiId : '‚Äî';
      $('#sumPhone').textContent = u? u.phone : '‚Äî';
      
      const tbody = $('#stmtBody');
      tbody.innerHTML = '';
      if(u){
        for(const t of u.txns.slice(0,10)){ // Show only last 10 transactions
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${human(t.ts)}</td>
                          <td>${t.type}</td>
                          <td>${t.note||''}</td>
                          <td class="right ${t.type.includes('withdraw')||t.type==='transfer-out'||t.type==='upi-send'?'bad':'good'}">${fmt(t.amount)}</td>
                          <td class="right">${fmt(t.postBal)}</td>`;
          tbody.appendChild(tr);
        }
      }
    }

    function refreshATMCardList(){
      const sel = $('#atmCard');
      const users = DB.allUsers();
      sel.innerHTML = users.length? '' : '<option value="">No accounts yet</option>';
      for(const u of users){
        const opt = document.createElement('option');
        opt.value = u.acc; opt.textContent = `${u.name} ‚Äî ${u.acc}`; sel.appendChild(opt);
      }
    }
    
    function generateUpiQrCode() {
      const container = $('#upiQrContainer');
      if(!currentAcc) {
        container.innerHTML = '<p>Login to view your UPI QR code</p>';
        $('#upiIdDisplay').textContent = 'Not logged in';
        return;
      }
      
      const user = DB.getUser(currentAcc);
      const upiId = user.upiId;
      const qrData = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(user.name)}&am=0&tn=Payment&cu=INR`;
      
      // In a real app, you'd generate a proper QR code here
      // For demo, we'll create a simple visual representation
      container.innerHTML = `
        <div class="qr-code">
          <div style="font-size:12px; margin-bottom:8px;">Scan to pay</div>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(qrData)}" alt="UPI QR Code" />
          <div style="font-size:12px; margin-top:8px;">${user.name}</div>
        </div>
      `;
      
      $('#upiIdDisplay').textContent = upiId;
    }
    
    function refreshUpiHistory() {
      if(!currentAcc) return;
      const txns = DB.getUserUpiTxns(currentAcc);
      const tbody = $('#upiHistoryBody');
      tbody.innerHTML = '';
      
      for(const t of txns) {
        const tr = document.createElement('tr');
        const isOutgoing = t.from === currentAcc;
        const otherParty = isOutgoing ? t.toUpi : t.fromUpi;
        const type = isOutgoing ? 'Send' : 'Receive';
        
        tr.innerHTML = `
          <td>${human(t.ts)}</td>
          <td>${type}</td>
          <td>${otherParty}</td>
          <td>${t.note || ''}</td>
          <td class="right ${isOutgoing ? 'bad' : 'good'}">${fmt(t.amount)}</td>
          <td class="${t.status === 'success' ? 'success' : t.status === 'failed' ? 'failed' : 'pending'}">
            ${t.status}
          </td>
        `;
        tbody.appendChild(tr);
      }
    }
    
    function addPhoneTransaction(message, isSuccess = true) {
      const screen = $('#phoneScreen');
      const now = new Date();
      const timeStr = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      
      const div = document.createElement('div');
      div.className = `transaction-item ${isSuccess ? 'success' : 'failed'}`;
      div.innerHTML = `
        <div>${message}</div>
        <div class="amount">${timeStr}</div>
      `;
      
      screen.insertBefore(div, screen.firstChild);
    }

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Account creation
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Show security answer fields when questions are selected
    $('#securityQuestion1').addEventListener('change', (e) => {
      $('#securityAnswer1').style.display = e.target.value ? 'block' : 'none';
    });
    
    $('#securityQuestion2').addEventListener('change', (e) => {
      $('#securityAnswer2').style.display = e.target.value ? 'block' : 'none';
    });
    
    $('#btnOpenAccount').addEventListener('click', ()=>{
      const name = $('#regName').value.trim();
      const phone = $('#regPhone').value.trim();
      const pin = $('#regPIN').value.trim();
      const pinConfirm = $('#regPINConfirm').value.trim();
      const out = $('#regOut');
      
      const question1 = $('#securityQuestion1').value;
      const answer1 = $('#securityAnswer1').value.trim();
      const question2 = $('#securityQuestion2').value;
      const answer2 = $('#securityAnswer2').value.trim();
      
      try{
        if(!name) throw new Error('Name required');
        if(!/^[0-9]{10}$/.test(phone.replace(/\s+/g,''))) throw new Error('Phone must be 10 digits');
        if(!/^\d{4}$/.test(pin)) throw new Error('PIN must be 4 digits');
        if(pin !== pinConfirm) throw new Error('PINs do not match');
        
        // Validate security questions
        if(!question1 || !answer1 || !question2 || !answer2) {
          throw new Error('Please select and answer both security questions');
        }
        
        const securityQuestions = [
          { question: question1, answer: answer1 },
          { question: question2, answer: answer2 }
        ];
        
        const user = DB.createUser(name, phone, pin, securityQuestions);
        toast(out, `Account created ‚úÖ Account No: ${user.acc}. UPI ID: ${user.upiId}`, 'var(--accent-2)');
        refreshATMCardList();
      }catch(e){ toast(out, e.message, 'var(--danger)'); }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Login / Logout
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnLogin').addEventListener('click', ()=>{
      const acc = $('#loginAcc').value.trim();
      const pin = $('#loginPIN').value.trim();
      const ok = DB.verify(acc, pin);
      const badge = $('#loginMsg');
      if(ok){ 
        currentAcc = acc; 
        badge.style.display='inline-flex'; 
        badge.textContent='Logged in'; 
        refreshSummary(); 
        
        // If on UPI tab, refresh UPI elements
        if($('#upi').style.display === 'block') {
          generateUpiQrCode();
          refreshUpiHistory();
        }
      }
      else { badge.style.display='inline-flex'; badge.textContent='Login failed'; }
    });
    
    $('#btnLogout').addEventListener('click', ()=>{ 
      currentAcc = null; 
      refreshSummary(); 
      $('#loginMsg').style.display='none'; 
      
      // Clear UPI display if on that tab
      if($('#upi').style.display === 'block') {
        $('#upiQrContainer').innerHTML = '<p>Login to view your UPI QR code</p>';
        $('#upiIdDisplay').textContent = 'Not logged in';
        $('#upiHistoryBody').innerHTML = '';
      }
    });
    
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Forgot PIN functionality
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnForgotPIN').addEventListener('click', () => {
      showModal('#forgotPINModal');
      resetModal('#forgotPINModal');
      $('#forgotPINStep1').style.display = 'block';
      $('#forgotPINStep2').style.display = 'none';
      $('#btnNextForgotPIN').style.display = 'inline-flex';
      $('#btnResetPIN').style.display = 'none';
    });
    
    $('#btnAtmForgotPIN').addEventListener('click', () => {
      showModal('#forgotPINModal');
      resetModal('#forgotPINModal');
      $('#forgotPINStep1').style.display = 'block';
      $('#forgotPINStep2').style.display = 'none';
      $('#btnNextForgotPIN').style.display = 'inline-flex';
      $('#btnResetPIN').style.display = 'none';
      
      // Pre-fill account number if card is selected in ATM
      const atmCard = $('#atmCard').value;
      if(atmCard) {
        $('#forgotPINAcc').value = atmCard;
      }
    });
    
    $('#btnNextForgotPIN').addEventListener('click', () => {
      const acc = $('#forgotPINAcc').value.trim();
      const errorEl = $('#forgotPINError');
      
      if(!acc) {
        toast(errorEl, 'Please enter your account number', 'var(--danger)');
        return;
      }
      
      const user = DB.getUser(acc);
      if(!user) {
        toast(errorEl, 'Account not found', 'var(--danger)');
        return;
      }
      
      // Show security questions
      $('#forgotPINStep1').style.display = 'none';
      $('#forgotPINStep2').style.display = 'block';
      $('#btnNextForgotPIN').style.display = 'none';
      $('#btnResetPIN').style.display = 'inline-flex';
      
      const container = $('#securityQuestionsContainer');
      container.innerHTML = '';
      
      // Show one random security question
      const randomQuestion = user.securityQuestions[
        Math.floor(Math.random() * user.securityQuestions.length)
      ];
      
      const div = document.createElement('div');
      div.className = 'security-question';
      div.innerHTML = `
        <label>${randomQuestion.question}</label>
        <input type="text" class="security-answer" data-question="${randomQuestion.question}" 
               placeholder="Your answer" />
      `;
      container.appendChild(div);
    });
    
    $('#btnResetPIN').addEventListener('click', () => {
      const acc = $('#forgotPINAcc').value.trim();
      const newPIN = $('#newPIN').value.trim();
      const newPINConfirm = $('#newPINConfirm').value.trim();
      const successEl = $('#forgotPINSuccess');
      
      // Get security answers
      const answers = [];
      $$('.security-answer').forEach(input => {
        answers.push({
          question: input.dataset.question,
          answer: input.value.trim()
        });
      });
      
      try {
        if(!newPIN || !newPINConfirm) {
          throw new Error('Please enter and confirm your new PIN');
        }
        
        if(newPIN !== newPINConfirm) {
          throw new Error('PINs do not match');
        }
        
        if(!/^\d{4}$/.test(newPIN)) {
          throw new Error('PIN must be exactly 4 digits');
        }
        
        // Verify security questions
        if(!DB.verifySecurityQuestions(acc, answers)) {
          throw new Error('Security answer is incorrect');
        }
        
        // Reset PIN
        DB.resetPIN(acc, newPIN);
        
        // Show success
        toast(successEl, `PIN reset successfully! Your new PIN is ${newPIN}`, 'var(--accent-2)');
        successEl.style.display = 'block';
        
        // Close modal after delay
        setTimeout(() => {
          hideModal('#forgotPINModal');
          resetModal('#forgotPINModal');
        }, 2000);
      } catch(e) {
        toast($('#forgotPINError'), e.message, 'var(--danger)');
      }
    });
    
    $('#btnCancelForgotPIN').addEventListener('click', () => {
      hideModal('#forgotPINModal');
      resetModal('#forgotPINModal');
    });
    
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Change PIN functionality
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnChangePIN').addEventListener('click', () => {
      if(!currentAcc) {
        alert('Please login first');
        return;
      }
      
      showModal('#changePINModal');
      resetModal('#changePINModal');
    });
    
    $('#btnSubmitChangePIN').addEventListener('click', () => {
      const currentPIN = $('#currentPIN').value.trim();
      const newPIN = $('#changeNewPIN').value.trim();
      const newPINConfirm = $('#changeNewPINConfirm').value.trim();
      const upiPIN = $('#changeUPIPINVerify').value.trim();
      const errorEl = $('#changePINError');
      const successEl = $('#changePINSuccess');
      
      try {
        if(!currentPIN || !newPIN || !newPINConfirm || !upiPIN) {
          throw new Error('Please fill all fields');
        }
        
        if(newPIN !== newPINConfirm) {
          throw new Error('New PINs do not match');
        }
        
        if(!/^\d{4}$/.test(newPIN)) {
          throw new Error('PIN must be exactly 4 digits');
        }
        
        if(!DB.verifyUpiPin(currentAcc, upiPIN)) {
          throw new Error('UPI PIN verification failed');
        }
        
        // Change PIN
        DB.changePIN(currentAcc, currentPIN, newPIN);
        
        // Show success
        toast(successEl, 'PIN changed successfully!', 'var(--accent-2)');
        successEl.style.display = 'block';
        
        // Close modal after delay
        setTimeout(() => {
          hideModal('#changePINModal');
          resetModal('#changePINModal');
        }, 2000);
      } catch(e) {
        toast(errorEl, e.message, 'var(--danger)');
      }
    });
    
    $('#btnCancelChangePIN').addEventListener('click', () => {
      hideModal('#changePINModal');
      resetModal('#changePINModal');
    });
    
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Change UPI PIN functionality
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnChangeUPIPIN').addEventListener('click', () => {
      if(!currentAcc) {
        alert('Please login first');
        return;
      }
      
      showModal('#changeUPIPINModal');
      resetModal('#changeUPIPINModal');
    });
    
    $('#btnSubmitChangeUPIPIN').addEventListener('click', () => {
      const currentUPIPIN = $('#currentUPIPIN').value.trim();
      const newUPIPIN = $('#newUPIPIN').value.trim();
      const newUPIPINConfirm = $('#newUPIPINConfirm').value.trim();
      const accountPIN = $('#changeUPIPINAccountPIN').value.trim();
      const errorEl = $('#changeUPIPINError');
      const successEl = $('#changeUPIPINSuccess');
      
      try {
        if(!currentUPIPIN || !newUPIPIN || !newUPIPINConfirm || !accountPIN) {
          throw new Error('Please fill all fields');
        }
        
        if(newUPIPIN !== newUPIPINConfirm) {
          throw new Error('New UPI PINs do not match');
        }
        
        if(!/^\d{6}$/.test(newUPIPIN)) {
          throw new Error('UPI PIN must be exactly 6 digits');
        }
        
        if(!DB.verify(currentAcc, accountPIN)) {
          throw new Error('Account PIN verification failed');
        }
        
        // Change UPI PIN
        DB.changeUPIPIN(currentAcc, currentUPIPIN, newUPIPIN);
        
        // Show success
        toast(successEl, 'UPI PIN changed successfully!', 'var(--accent-2)');
        successEl.style.display = 'block';
        
        // Close modal after delay
        setTimeout(() => {
          hideModal('#changeUPIPINModal');
          resetModal('#changeUPIPINModal');
        }, 2000);
      } catch(e) {
        toast(errorEl, e.message, 'var(--danger)');
      }
    });
    
    $('#btnCancelChangeUPIPIN').addEventListener('click', () => {
      hideModal('#changeUPIPINModal');
      resetModal('#changeUPIPINModal');
    });
    
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Forgot UPI PIN functionality
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnForgotUPIPIN').addEventListener('click', () => {
      showModal('#forgotUPIPINModal');
      resetModal('#forgotUPIPINModal');
      $('#forgotUPIPINStep1').style.display = 'block';
      $('#forgotUPIPINStep2').style.display = 'none';
      $('#btnNextForgotUPIPIN').style.display = 'inline-flex';
      $('#btnResetUPIPIN').style.display = 'none';
    });
    
    $('#btnNextForgotUPIPIN').addEventListener('click', () => {
      const acc = $('#forgotUPIPINAcc').value.trim();
      const errorEl = $('#forgotUPIPINError');
      
      if(!acc) {
        toast(errorEl, 'Please enter your account number', 'var(--danger)');
        return;
      }
      
      const user = DB.getUser(acc);
      if(!user) {
        toast(errorEl, 'Account not found', 'var(--danger)');
        return;
      }
      
      // Show security questions
      $('#forgotUPIPINStep1').style.display = 'none';
      $('#forgotUPIPINStep2').style.display = 'block';
      $('#btnNextForgotUPIPIN').style.display = 'none';
      $('#btnResetUPIPIN').style.display = 'inline-flex';
      
      const container = $('#upiSecurityQuestionsContainer');
      container.innerHTML = '';
      
      // Show one random security question
      const randomQuestion = user.securityQuestions[
        Math.floor(Math.random() * user.securityQuestions.length)
      ];
      
      const div = document.createElement('div');
      div.className = 'security-question';
      div.innerHTML = `
        <label>${randomQuestion.question}</label>
        <input type="text" class="security-answer" data-question="${randomQuestion.question}" 
               placeholder="Your answer" />
      `;
      container.appendChild(div);
    });
    
    $('#btnResetUPIPIN').addEventListener('click', () => {
      const acc = $('#forgotUPIPINAcc').value.trim();
      const newUPIPIN = $('#newUPIPINReset').value.trim();
      const newUPIPINConfirm = $('#newUPIPINResetConfirm').value.trim();
      const successEl = $('#forgotUPIPINSuccess');
      
      // Get security answers
      const answers = [];
      $$('.security-answer').forEach(input => {
        answers.push({
          question: input.dataset.question,
          answer: input.value.trim()
        });
      });
      
      try {
        if(!newUPIPIN || !newUPIPINConfirm) {
          throw new Error('Please enter and confirm your new UPI PIN');
        }
        
        if(newUPIPIN !== newUPIPINConfirm) {
          throw new Error('UPI PINs do not match');
        }
        
        if(!/^\d{6}$/.test(newUPIPIN)) {
          throw new Error('UPI PIN must be exactly 6 digits');
        }
        
        // Verify security questions
        if(!DB.verifySecurityQuestions(acc, answers)) {
          throw new Error('Security answer is incorrect');
        }
        
        // Reset UPI PIN
        DB.resetUPIPIN(acc, newUPIPIN);
        
        // Show success
        toast(successEl, `UPI PIN reset successfully! Your new UPI PIN is ${newUPIPIN}`, 'var(--accent-2)');
        successEl.style.display = 'block';
        
        // Close modal after delay
        setTimeout(() => {
          hideModal('#forgotUPIPINModal');
          resetModal('#forgotUPIPINModal');
        }, 2000);
      } catch(e) {
        toast($('#forgotUPIPINError'), e.message, 'var(--danger)');
      }
    });
    
    $('#btnCancelForgotUPIPIN').addEventListener('click', () => {
      hideModal('#forgotUPIPINModal');
      resetModal('#forgotUPIPINModal');
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Deposit / Withdraw
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnDoTxn').addEventListener('click', ()=>{
      const out = $('#txnOut');
      if(!currentAcc){ toast(out,'Please login first','var(--warn)'); return }
      const amt = parseFloat($('#txnAmount').value);
      const type = $('#txnType').value;
      const note = $('#txnNote').value.trim();
      try{
        DB.postTxn(currentAcc, type, amt, note);
        toast(out, `${type==='deposit'?'Deposited':'Withdrawn'} ${fmt(amt)} ‚úî`, 'var(--accent-2)');
        refreshSummary();
      }catch(e){ toast(out, e.message, 'var(--danger)'); }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // Transfer
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnTransfer').addEventListener('click', ()=>{
      const out = $('#transferOut');
      if(!currentAcc){ toast(out,'Please login first','var(--warn)'); return }
      const toAcc = $('#toAcc').value.trim();
      const amt = parseFloat($('#toAmt').value);
      const pin = $('#toPIN').value.trim();
      try{
        if(!DB.verify(currentAcc, pin)) throw new Error('Invalid PIN');
        DB.transfer(currentAcc, toAcc, amt);
        toast(out, `Transferred ${fmt(amt)} to ${toAcc} ‚úî`, 'var(--accent-2)');
        refreshSummary();
      }catch(e){ toast(out, e.message, 'var(--danger)'); }
    });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // ATM logic
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    let atmSession = { acc: null, tries: 0, locked: false };

    function atmSetStatus(msg){ $('#atmStatus').textContent = msg; }
    function atmSetActive(acc){ $('#atmActive').textContent = acc || '‚Äî'; }

    $('#btnAtmEnter').addEventListener('click', ()=>{
      const acc = $('#atmCard').value;
      const pin = $('#atmPIN').value.trim();
      const msg = $('#atmAuthMsg');
      if(!acc){ toast(msg,'Select an account as card','var(--warn)'); return }
      if(atmSession.locked){ toast(msg,'ATM session locked. Eject card to reset.','var(--danger)'); return }
      if(DB.verify(acc, pin)){
        atmSession = { acc, tries: 0, locked: false };
        atmSetActive(acc); atmSetStatus('Authenticated');
        toast(msg,'PIN verified ‚úî','var(--accent-2)');
        renderAtmStatement();
      } else {
        atmSession.tries++;
        if(atmSession.tries>=3){ atmSession.locked = true; toast(msg,'3 wrong PIN attempts. Locked.','var(--danger)'); atmSetStatus('LOCKED'); }
        else toast(msg,`Wrong PIN. Attempts: ${atmSession.tries}/3`,'var(--danger)');
      }
    });

    $('#btnAtmWithdraw').addEventListener('click', ()=>{
      const out = $('#atmOut');
      if(!atmSession.acc || atmSession.locked){ toast(out,'Authenticate first','var(--warn)'); return }
      const amt = parseFloat($('#atmAmt').value);
      try{ 
        DB.postTxn(atmSession.acc, 'withdraw', amt, 'ATM Cash'); 
        toast(out, `Dispensed ${fmt(amt)} üí∏`, 'var(--accent-2)'); 
        atmSetStatus('Transaction OK'); 
        renderAtmStatement(); 
        refreshSummary(); 
      }
      catch(e){ toast(out, e.message, 'var(--danger)'); atmSetStatus('Transaction Failed') }
    });

    $('#btnAtmBal').addEventListener('click', ()=>{
      const out = $('#atmOut');
      if(!atmSession.acc || atmSession.locked){ toast(out,'Authenticate first','var(--warn)'); return }
      const u = DB.getUser(atmSession.acc); toast(out, `Available balance: ${fmt(u.balance)}`, 'var(--accent-2)'); atmSetStatus('Balance shown');
    });

    function renderAtmStatement(){
      const tbody = $('#atmStmtBody'); tbody.innerHTML = '';
      if(!atmSession.acc) return;
      const u = DB.getUser(atmSession.acc);
      (u.txns.slice(0,5)).forEach(t=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${human(t.ts)}</td>
                        <td>${t.type}</td>
                        <td>${t.note||''}</td>
                        <td class="right ${t.type.includes('withdraw')||t.type==='transfer-out'?'bad':'good'}">${fmt(t.amount)}</td>
                        <td class="right">${fmt(t.postBal)}</td>`;
        tbody.appendChild(tr);
      });
    }

    $('#btnAtmMini').addEventListener('click', ()=>{ if(!atmSession.acc){ toast($('#atmOut'),'Authenticate first','var(--warn)'); return } renderAtmStatement(); atmSetStatus('Mini statement'); });
    $('#btnAtmEject').addEventListener('click', ()=>{ atmSession = { acc:null, tries:0, locked:false }; atmSetActive(null); atmSetStatus('Card ejected'); $('#atmAuthMsg').textContent=''; $('#atmOut').textContent=''; $('#atmStmtBody').innerHTML=''; });

    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    // UPI Payments
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    $('#btnUpiSend').addEventListener('click', ()=>{
      const out = $('#upiOut');
      if(!currentAcc){ toast(out,'Please login first','var(--warn)'); return }
      
      const toUpi = $('#upiTo').value.trim();
      const amount = parseFloat($('#upiAmt').value);
      const note = $('#upiNote').value.trim();
      const upiPin = $('#upiPIN').value.trim();
      
      try {
        if(!toUpi) throw new Error('Recipient UPI ID required');
        if(!/^[\w.-]+@[\w.-]+$/.test(toUpi)) throw new Error('Invalid UPI ID format');
        if(!amount || amount <= 0) throw new Error('Invalid amount');
        if(!/^\d{6}$/.test(upiPin)) throw new Error('UPI PIN must be 6 digits');
        if(!DB.verifyUpiPin(currentAcc, upiPin)) throw new Error('Invalid UPI PIN');
        
        const result = DB.upiTransfer(currentAcc, toUpi, amount, note);
        toast(out, `Payment of ${fmt(amount)} to ${toUpi} successful!`, 'var(--accent-2)');
        refreshSummary();
        refreshUpiHistory();
        
        // Add to phone simulator
        addPhoneTransaction(`Paid to ${toUpi} - ${note || 'Payment'}`, true);
      } catch(e) {
        toast(out, e.message, 'var(--danger)');
        addPhoneTransaction(`Failed: ${e.message}`, false);
      }
    });
    
    $('#btnUpiRequest').addEventListener('click', ()=>{
      const out = $('#upiReqOut');
      if(!currentAcc){ toast(out,'Please login first','var(--warn)'); return }
      
      const fromUpi = $('#upiFrom').value.trim();
      const amount = parseFloat($('#upiReqAmt').value);
      const note = $('#upiReqNote').value.trim();
      
      try {
        if(!fromUpi) throw new Error('Requester UPI ID required');
        if(!/^[\w.-]+@[\w.-]+$/.test(fromUpi)) throw new Error('Invalid UPI ID format');
        if(!amount || amount <= 0) throw new Error('Invalid amount');
        
        const request = DB.requestUpiPayment(fromUpi, currentAcc, amount, note);
        toast(out, `Payment request sent to ${fromUpi} for ${fmt(amount)}`, 'var(--accent-2)');
        refreshUpiHistory();
        
        // Add to phone simulator
        addPhoneTransaction(`Requested ${fmt(amount)} from ${fromUpi}`, true);
      } catch(e) {
        toast(out, e.message, 'var(--danger)');
        addPhoneTransaction(`Failed: ${e.message}`, false);
      }
    });
    
    $('#btnRefreshQr').addEventListener('click', generateUpiQrCode);
    
    // Phone simulator buttons
    $('#btnScanQr').addEventListener('click', ()=>{
      if(!currentAcc) {
        addPhoneTransaction('Please login first to scan QR', false);
        return;
      }
      
      // In a real app, this would open a camera/scanner
      // For demo, we'll simulate scanning the logged-in user's own QR
      const user = DB.getUser(currentAcc);
      const qrData = `upi://pay?pa=${user.upiId}&pn=${encodeURIComponent(user.name)}&am=100&tn=Demo%20Payment&cu=INR`;
      
      addPhoneTransaction('QR scanned successfully', true);
      
      // Simulate processing
      setTimeout(() => {
        addPhoneTransaction(`Payment request to ${user.upiId} for ‚Çπ100`, true);
        
        // Confirm payment after delay
        setTimeout(() => {
          const confirm = confirm(`Approve payment of ‚Çπ100 to ${user.name} (${user.upiId})?`);
          if(confirm) {
            try {
              DB.upiTransfer(currentAcc, user.upiId, 100, 'Demo QR Payment');
              addPhoneTransaction(`Paid ‚Çπ100 to ${user.upiId}`, true);
              refreshSummary();
              refreshUpiHistory();
            } catch(e) {
              addPhoneTransaction(`Payment failed: ${e.message}`, false);
            }
          } else {
            addPhoneTransaction('Payment cancelled by user', false);
          }
        }, 1000);
      }, 1000);
    });
    
    $('#btnPayContact').addEventListener('click', ()=>{
      if(!currentAcc) {
        addPhoneTransaction('Please login first to make payments', false);
        return;
      }
      
      const users = DB.allUsers().filter(u => u.acc !== currentAcc);
      if(users.length === 0) {
        addPhoneTransaction('No other accounts found to pay', false);
        return;
      }
      
      // Pick a random contact for demo
      const contact = users[Math.floor(Math.random() * users.length)];
      
      // Simulate payment flow
      addPhoneTransaction(`Selected contact: ${contact.name}`, true);
      
      setTimeout(() => {
        addPhoneTransaction(`Enter amount to pay ${contact.upiId}`, true);
        
        // For demo, we'll use a fixed amount
        setTimeout(() => {
          const amount = 50 + Math.floor(Math.random() * 150); // Random amount 50-200
          const confirmPay = confirm(`Send ‚Çπ${amount} to ${contact.name} (${contact.upiId})?`);
          
          if(confirmPay) {
            try {
              DB.upiTransfer(currentAcc, contact.upiId, amount, 'Contact Payment');
              addPhoneTransaction(`Paid ‚Çπ${amount} to ${contact.name}`, true);
              refreshSummary();
              refreshUpiHistory();
            } catch(e) {
              addPhoneTransaction(`Payment failed: ${e.message}`, false);
            }
          } else {
            addPhoneTransaction('Payment cancelled by user', false);
          }
        }, 800);
      }, 800);
    });

    // Init
    refreshSummary();
    refreshATMCardList();
    
    // Initialize security questions
    $('#securityQuestion1').dispatchEvent(new Event('change'));
    $('#securityQuestion2').dispatchEvent(new Event('change'));
  </script>
</body>
</html>