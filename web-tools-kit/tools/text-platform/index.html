<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Secure Examination System</title>
  <style>
    :root {
      --primary-color: #4361ee;
      --primary-dark: #3a56d4;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --danger-color: #f72585;
      --warning-color: #f8961e;
      --info-color: #4895ef;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --text-color: #333;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --input-bg: #f8f9fa;
      --modal-bg: #ffffff;
    }

    .dark-mode {
      --primary-color: #4895ef;
      --primary-dark: #3a56d4;
      --secondary-color: #4361ee;
      --text-color: #f8f9fa;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --border-color: #333;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --input-bg: #2d2d2d;
      --modal-bg: #252525;
      --light-color: #2d2d2d;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 0;
      color: var(--text-color);
    }

    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 30px;
      background: var(--card-bg);
      border: 2px solid var(--primary-color);
      box-shadow: 0 10px 25px var(--shadow-color);
      border-radius: 15px;
    }

    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .form-section {
      margin-bottom: 25px;
      padding: 20px;
      background: var(--light-color);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .form-section h3 {
      margin-top: 0;
      color: var(--primary-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    #paperInput, #adminPaperInput {
      width: 100%;
      height: 200px;
      padding: 15px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--input-bg);
      resize: vertical;
      transition: border-color 0.3s;
      color: var(--text-color);
    }

    #paperInput:focus, #adminPaperInput:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    label {
      font-weight: bold;
      display: block;
      margin: 15px 0 5px;
      color: var(--text-color);
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    input[type="datetime-local"],
    select {
      padding: 10px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      width: 100%;
      background-color: var(--input-bg);
      transition: border-color 0.3s;
      color: var(--text-color);
    }

    input:focus, select:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 30px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    #startBtn, #studentStartBtn {
      background-color: var(--success-color);
      color: white;
    }

    #startBtn:hover, #studentStartBtn:hover {
      background-color: #3aa8d8;
      transform: scale(1.03);
    }

    #resetBtn {
      background-color: var(--light-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    #resetBtn:hover {
      background-color: var(--border-color);
      transform: scale(1.03);
    }

    #submitBtn {
      background-color: var(--primary-color);
      color: white;
      display: none;
    }

    #submitBtn:hover {
      background-color: var(--primary-dark);
      transform: scale(1.03);
    }

    #testWindow {
      display: none;
      background-color: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 25px;
      margin-top: 30px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: inset 0 0 10px var(--shadow-color);
    }

    #timer {
      font-size: 24px;
      font-weight: bold;
      color: var(--danger-color);
      padding: 10px;
      background: rgba(220, 53, 69, 0.1);
      border: 2px dashed rgba(220, 53, 69, 0.3);
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }

    #instruction {
      color: var(--primary-color);
      background: rgba(67, 97, 238, 0.1);
      padding: 15px;
      border: 1px solid rgba(67, 97, 238, 0.3);
      border-radius: 10px;
      margin-bottom: 15px;
      font-weight: bold;
      text-align: center;
      line-height: 1.5;
    }

    #testContent {
      font-size: 18px;
      line-height: 1.6;
      white-space: pre-wrap;
      padding: 20px;
      border: 2px solid var(--border-color);
      background: var(--light-color);
      border-radius: 10px;
      overflow-wrap: break-word;
    }

    .statusBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: bold;
      flex-wrap: wrap;
      gap: 10px;
    }

    .fullscreen-warning {
      color: var(--danger-color);
      font-size: 14px;
      text-align: center;
      margin-top: 15px;
      font-style: italic;
      padding: 10px;
      background-color: rgba(220, 53, 69, 0.1);
      border-radius: 5px;
    }

    .warning-box {
      background-color: rgba(248, 215, 218, 0.3);
      border-left: 4px solid var(--danger-color);
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 5px 5px 0;
      color: var(--text-color);
    }

    .progress-container {
      width: 100%;
      height: 10px;
      background-color: var(--border-color);
      border-radius: 5px;
      margin: 15px 0;
    }

    .progress-bar {
      height: 100%;
      border-radius: 5px;
      background-color: var(--success-color);
      width: 100%;
      transition: width 1s linear;
    }

    .test-actions {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 15px;
    }

    .student-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .test-schedule {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .auth-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .admin-panel {
      display: none;
      margin-bottom: 30px;
    }

    .student-view {
      display: none;
    }

    .switch-view {
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .switch-view-buttons {
      display: flex;
      gap: 10px;
    }

    .switch-view button {
      background-color: #6c757d;
      color: white;
    }

    .switch-view button:hover {
      background-color: #5a6268;
    }

    .student-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
    }

    .student-item {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-item:last-child {
      border-bottom: none;
    }

    .student-item button {
      padding: 5px 10px;
      font-size: 14px;
    }

    .logout-btn {
      background-color: var(--danger-color);
      color: white;
      margin-top: 15px;
    }

    .logout-btn:hover {
      background-color: #d61a58;
    }

    .admin-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .test-status {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-scheduled {
      background-color: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }

    .status-active {
      background-color: rgba(40, 167, 69, 0.2);
      color: #28a745;
    }

    .status-completed {
      background-color: rgba(220, 53, 69, 0.2);
      color: #dc3545;
    }

    .status-expired {
      background-color: rgba(108, 117, 125, 0.2);
      color: #6c757d;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: var(--modal-bg);
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 5px 15px var(--shadow-color);
      position: relative;
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }

    .close-modal:hover {
      color: var(--text-color);
    }

    .test-details {
      margin-top: 20px;
    }

    .test-details p {
      margin: 10px 0;
    }

    .test-details strong {
      display: inline-block;
      width: 150px;
    }

    .test-countdown {
      margin-top: 10px;
      padding: 10px;
      background-color: rgba(67, 97, 238, 0.1);
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }

    .dark-mode-toggle {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dark-mode-toggle:hover {
      background-color: var(--border-color);
    }

    .test-schedule-info {
      margin-top: 10px;
      padding: 10px;
      background-color: rgba(67, 97, 238, 0.1);
      border-radius: 5px;
      font-size: 14px;
      text-align: center;
    }

    .test-schedule-info.active {
      background-color: rgba(40, 167, 69, 0.1);
    }

    .test-schedule-info.scheduled {
      background-color: rgba(255, 193, 7, 0.1);
    }

    .test-schedule-info.completed {
      background-color: rgba(220, 53, 69, 0.1);
    }

    /* Enhanced styles for test questions */
    .question-container {
      margin-bottom: 20px;
      padding: 15px;
      background-color: rgba(67, 97, 238, 0.05);
      border-radius: 8px;
      border-left: 4px solid var(--primary-color);
    }

    .question-text {
      font-weight: bold;
      margin-bottom: 10px;
    }

    .answer-option {
      margin: 5px 0;
      padding: 8px 12px;
      background-color: var(--light-color);
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .answer-option:hover {
      background-color: rgba(67, 97, 238, 0.1);
    }

    .answer-option.selected {
      background-color: rgba(67, 97, 238, 0.2);
      border-left: 3px solid var(--primary-color);
    }

    /* Enhanced security warning */
    .security-warning {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background-color: var(--danger-color);
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      z-index: 1000;
      display: none;
    }

    /* Enhanced test results */
    .test-results {
      margin-top: 20px;
      padding: 20px;
      background-color: var(--light-color);
      border-radius: 10px;
    }

    .result-item {
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .result-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    /* Enhanced admin controls */
    .admin-controls {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .admin-control-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 15px;
      background-color: var(--light-color);
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .admin-control-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px var(--shadow-color);
    }

    .admin-control-btn i {
      font-size: 24px;
      margin-bottom: 10px;
    }

    /* Enhanced responsive design */
    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      .statusBar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        padding: 15px 30px;
        font-size: 18px;
      }

      #paperInput, #adminPaperInput {
        font-size: 18px;
      }

      #timer, #currentTime {
        font-size: 20px;
      }

      #instruction {
        font-size: 18px;
      }

      #testContent {
        font-size: 20px;
      }

      .student-info,
      .test-schedule,
      .auth-section {
        grid-template-columns: 1fr;
      }

      .modal-content {
        margin: 20% auto;
        width: 90%;
      }

      .switch-view {
        flex-direction: column;
        gap: 10px;
      }

      .switch-view-buttons {
        width: 100%;
        justify-content: space-between;
      }

      .admin-controls {
        grid-template-columns: 1fr 1fr;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 15px;
      }

      .student-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .student-item div:last-child {
        align-self: flex-end;
      }

      .admin-controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="switch-view">
      <div class="switch-view-buttons">
        <button id="adminViewBtn" onclick="showAdminView()">Admin Panel</button>
        <button id="studentViewBtn" onclick="showStudentView()">Student View</button>
      </div>
      <button id="darkModeToggle" class="dark-mode-toggle" onclick="toggleDarkMode()">üåì</button>
    </div>
    
    <!-- Admin Panel Section -->
    <div id="adminPanel" class="admin-panel">
      <h2>üîê Admin Panel</h2>
      
      <div class="form-section">
        <h3>Admin Authentication</h3>
        <div id="adminLoginForm">
          <label for="adminPassword">Admin Password:</label>
          <input type="password" id="adminPassword" placeholder="Enter admin password">
          <button onclick="authenticateAdmin()">Login</button>
        </div>
        <div id="adminControls" style="display: none;">
          <div class="admin-actions">
            <button onclick="showAddTestForm()">‚ûï Add New Test</button>
            <button class="logout-btn" onclick="adminLogout()">üîí Logout</button>
          </div>
        </div>
      </div>
      
      <div id="adminMainControls" style="display: none;">
        <div class="form-section" id="addTestForm">
          <h3>üìù Create Student Test</h3>
          <div class="student-info">
            <div>
              <label for="adminStudentName">Full Name:</label>
              <input type="text" id="adminStudentName" placeholder="Enter student full name" required>
            </div>
            <div>
              <label for="adminRollNumber">Roll Number:</label>
              <input type="text" id="adminRollNumber" placeholder="Enter roll number" required>
            </div>
            <div>
              <label for="adminClassName">Class/Group:</label>
              <input type="text" id="adminClassName" placeholder="Enter class">
            </div>
            <div>
              <label for="adminStudentEmail">Email:</label>
              <input type="text" id="adminStudentEmail" placeholder="Enter email">
            </div>
          </div>
          
          <div class="test-schedule">
            <div>
              <label for="adminTestStartTime">Start Time:</label>
              <input type="datetime-local" id="adminTestStartTime">
            </div>
            <div>
              <label for="adminTestEndTime">End Time:</label>
              <input type="datetime-local" id="adminTestEndTime">
            </div>
          </div>
          
          <div>
            <label for="adminTestPassword">Test Password:</label>
            <input type="password" id="adminTestPassword" placeholder="Set test password" required>
            <small style="color: var(--text-color); opacity: 0.7;">(Students will need this to access their test)</small>
          </div>
          
          <div>
            <label for="adminDuration">Test Duration (minutes):</label>
            <input type="number" id="adminDuration" min="1" max="180" value="30" required>
          </div>
          
          <div>
            <label for="adminPaperInput">Test Content:</label>
            <textarea id="adminPaperInput" placeholder="Enter test questions here..." required></textarea>
          </div>
          
          <div class="button-group">
            <button onclick="addStudentTest()">Save Test</button>
            <button id="resetBtn" onclick="resetTestForm()">Reset Form</button>
          </div>
        </div>
        
        <div class="form-section">
          <h3>üë• Student Tests List</h3>
          <div class="input-group">
            <input type="text" id="searchTests" placeholder="Search by name, roll number or class..." oninput="filterTests()">
            <button onclick="filterTests()">üîç Search</button>
            <button onclick="exportAllTests()">üì§ Export All</button>
          </div>
          <div class="student-list" id="studentList">
            <!-- Student items will be added here dynamically -->
          </div>
        </div>

        <div class="form-section" id="bulkActions" style="display: none;">
          <h3>‚ö° Bulk Actions</h3>
          <div class="admin-controls">
            <div class="admin-control-btn" onclick="exportAllTests()">
              <span>üì§ Export All Tests</span>
            </div>
            <div class="admin-control-btn" onclick="importTests()">
              <span>üì• Import Tests</span>
            </div>
            <div class="admin-control-btn" onclick="clearAllTests()">
              <span>üóëÔ∏è Clear All Tests</span>
            </div>
            <div class="admin-control-btn" onclick="generateSampleData()">
              <span>üé≤ Generate Sample Data</span>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Student View Section -->
    <div id="studentView" class="student-view">
      <h2>üìù Examination Window</h2>
      
      <div class="form-section">
        <h3>üîí Test Authentication</h3>
        <div>
          <label for="studentTestPassword">Test Password:</label>
          <input type="password" id="studentTestPassword" placeholder="Enter your test password">
          <small style="color: var(--text-color); opacity: 0.7;">(Provided by your instructor)</small>
        </div>
        <div id="testScheduleInfo" class="test-schedule-info" style="display: none;"></div>
        <div class="button-group">
          <button id="studentStartBtn" onclick="startStudentTest()">
            <span class="icon">üöÄ</span>
            <span class="text">Start Test</span>
          </button>
          <button id="resetBtn" onclick="resetStudentView()">
            <span class="icon">üîÑ</span>
            <span class="text">Reset</span>
          </button>
        </div>
      </div>
      
      <div id="testWindow">
        <div class="statusBar">
          <div id="studentInfoDisplay"></div>
          <div id="currentTime"></div>
        </div>
        <div id="timer">Time Left: 30:00</div>
        <div class="progress-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="instruction">
          ‚ö†Ô∏è Examination in Progress - Strictly follow these rules:<br>
          1. Do not exit full screen or switch tabs/windows<br>
          2. Do not use any other applications<br>
          3. The test will be automatically submitted if rules are violated<br>
          4. Right-click and keyboard shortcuts are disabled<br>
          5. All actions are logged for security purposes
        </div>
        <div id="testContent"></div>
        <div class="test-actions">
          <button id="submitBtn" onclick="submitTest()">
            <span class="icon">‚úÖ</span>
            <span class="text">Submit Test</span>
          </button>
        </div>
        <div class="fullscreen-warning" id="fsWarning"></div>
      </div>
    </div>
  </div>

  <!-- Test Details Modal -->
  <div id="testDetailsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h3>Test Details</h3>
      <div class="test-details" id="modalTestDetails">
        <!-- Details will be populated here -->
      </div>
      <button onclick="closeModal()" style="margin-top: 20px;">Close</button>
    </div>
  </div>

  <!-- Import Tests Modal -->
  <div id="importModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeImportModal()">&times;</span>
      <h3>Import Tests</h3>
      <div class="form-section">
        <label for="importFile">Select JSON file to import:</label>
        <input type="file" id="importFile" accept=".json">
        <div class="button-group" style="margin-top: 20px;">
          <button onclick="processImport()">Import</button>
          <button onclick="closeImportModal()">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Security Warning Banner -->
  <div class="security-warning" id="securityWarning">
    SECURITY ALERT: Unauthorized actions are being logged. Any attempt to bypass security measures will result in automatic test submission.
  </div>

  <audio id="alertSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
  <audio id="warningSound" src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-991.mp3" preload="auto"></audio>

  <script>
    let countdown;
    let testActive = false;
    let timeLeft;
    let totalTime;
    let startTime;
    let tabSwitchCount = 0;
    const MAX_TAB_SWITCHES = 3;
    let testStartTime, testEndTime;
    let scheduleCheckInterval;
    const ADMIN_PASSWORD = "admin123"; // In production, use proper authentication
    let isAdminLoggedIn = false;
    let autoStartCheckInterval;
    let currentTest = null;
    let testScheduleInterval;
    let activityLog = [];
    
    // Student test database
    let studentTests = JSON.parse(localStorage.getItem('studentTests')) || [];
    
    // Initialize views
    document.addEventListener('DOMContentLoaded', function() {
      // Check for saved dark mode preference
      if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').textContent = 'üåû';
      }
      
      showAdminView();
      updateStudentList();
      
      // Set default test time to current time + 1 hour
      const now = new Date();
      const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
      
      document.getElementById('adminTestStartTime').value = now.toISOString().slice(0, 16);
      document.getElementById('adminTestEndTime').value = oneHourLater.toISOString().slice(0, 16);
      
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
      
      // Check for tests that should auto-start
      checkAutoStartTests();
      autoStartCheckInterval = setInterval(checkAutoStartTests, 60000); // Check every minute
      
      // Check for scheduled tests
      updateTestScheduleInfo();
      testScheduleInterval = setInterval(updateTestScheduleInfo, 1000);

      // Initialize activity log
      logActivity('System initialized', 'system');
    });
    
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      
      const isDarkMode = body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
      document.getElementById('darkModeToggle').textContent = isDarkMode ? 'üåû' : 'üåì';
      logActivity('Dark mode toggled', 'system');
    }
    
    function showAdminView() {
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('studentView').style.display = 'none';
      document.getElementById('adminViewBtn').style.backgroundColor = '#495057';
      document.getElementById('studentViewBtn').style.backgroundColor = '#6c757d';
      logActivity('Switched to admin view', 'navigation');
    }
    
    function showStudentView() {
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('studentView').style.display = 'block';
      document.getElementById('adminViewBtn').style.backgroundColor = '#6c757d';
      document.getElementById('studentViewBtn').style.backgroundColor = '#495057';
      
      // Hide admin view button when test is active
      if (testActive) {
        document.getElementById('adminViewBtn').style.display = 'none';
      } else {
        document.getElementById('adminViewBtn').style.display = 'flex';
      }
      logActivity('Switched to student view', 'navigation');
    }
    
    function authenticateAdmin() {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        document.getElementById('adminControls').style.display = 'block';
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('adminMainControls').style.display = 'block';
        document.getElementById('bulkActions').style.display = 'block';
        document.getElementById('adminPassword').style.borderColor = '#28a745';
        document.getElementById('adminPassword').value = '';
        logActivity('Admin logged in successfully', 'authentication');
      } else {
        showAlert("Incorrect admin password!");
        document.getElementById('adminPassword').style.borderColor = '#dc3545';
        logActivity('Failed admin login attempt', 'authentication', { attemptedPassword: password });
      }
    }
    
    function adminLogout() {
      isAdminLoggedIn = false;
      document.getElementById('adminControls').style.display = 'none';
      document.getElementById('adminLoginForm').style.display = 'block';
      document.getElementById('adminMainControls').style.display = 'none';
      document.getElementById('bulkActions').style.display = 'none';
      document.getElementById('adminPassword').style.borderColor = 'var(--border-color)';
      logActivity('Admin logged out', 'authentication');
    }
    
    function showAddTestForm() {
      document.getElementById('addTestForm').style.display = 'block';
      resetTestForm();
      logActivity('Add test form displayed', 'admin-action');
    }
    
    function resetTestForm() {
      document.getElementById('adminStudentName').value = '';
      document.getElementById('adminRollNumber').value = '';
      document.getElementById('adminClassName').value = '';
      document.getElementById('adminStudentEmail').value = '';
      document.getElementById('adminTestPassword').value = '';
      document.getElementById('adminDuration').value = '30';
      document.getElementById('adminPaperInput').value = '';
      
      const now = new Date();
      const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
      document.getElementById('adminTestStartTime').value = now.toISOString().slice(0, 16);
      document.getElementById('adminTestEndTime').value = oneHourLater.toISOString().slice(0, 16);
      logActivity('Test form reset', 'admin-action');
    }
    
    function addStudentTest() {
      const studentName = document.getElementById('adminStudentName').value.trim();
      const rollNumber = document.getElementById('adminRollNumber').value.trim();
      const className = document.getElementById('adminClassName').value.trim();
      const email = document.getElementById('adminStudentEmail').value.trim();
      const password = document.getElementById('adminTestPassword').value;
      const duration = parseInt(document.getElementById('adminDuration').value);
      const testContent = document.getElementById('adminPaperInput').value.trim();
      const startTime = document.getElementById('adminTestStartTime').value;
      const endTime = document.getElementById('adminTestEndTime').value;
      
      if (!studentName || !rollNumber || !password || !testContent) {
        showAlert("Please fill all required fields!");
        logActivity('Failed to add test - missing required fields', 'admin-action');
        return;
      }
      
      if (duration < 1 || duration > 180 || isNaN(duration)) {
        showAlert("Please enter a valid duration between 1 and 180 minutes");
        logActivity('Failed to add test - invalid duration', 'admin-action', { duration });
        return;
      }
      
      // Check if roll number already exists
      if (studentTests.some(test => test.rollNumber === rollNumber)) {
        if (!confirm("A test already exists for this roll number. Do you want to overwrite it?")) {
          logActivity('Test addition canceled - duplicate roll number', 'admin-action', { rollNumber });
          return;
        }
        // Remove existing test
        studentTests = studentTests.filter(test => test.rollNumber !== rollNumber);
        logActivity('Removed existing test for duplicate roll number', 'admin-action', { rollNumber });
      }
      
      const studentTest = {
        id: Date.now(),
        studentName,
        rollNumber,
        className,
        email,
        password,
        duration,
        testContent,
        startTime,
        endTime,
        createdAt: new Date().toISOString(),
        status: startTime ? getTestStatus(new Date(startTime), new Date(endTime)) : 'active',
        lastUpdated: new Date().toISOString()
      };
      
      studentTests.push(studentTest);
      saveStudentTests();
      updateStudentList();
      resetTestForm();
      
      showAlert("Student test added successfully!", "success");
      logActivity('Test added successfully', 'admin-action', { 
        studentName, 
        rollNumber,
        duration 
      });
    }
    
    function getTestStatus(startTime, endTime) {
      const now = new Date();
      if (now < startTime) return 'scheduled';
      if (now > endTime) return 'completed';
      return 'active';
    }
    
    function updateStudentList() {
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      
      if (studentTests.length === 0) {
        studentList.innerHTML = '<p>No student tests added yet.</p>';
        return;
      }
      
      // Sort tests by status (active first, then scheduled, then completed)
      const sortedTests = [...studentTests].sort((a, b) => {
        const statusOrder = {active: 1, scheduled: 2, completed: 3, expired: 4};
        return statusOrder[a.status] - statusOrder[b.status];
      });
      
      sortedTests.forEach(test => {
        const studentItem = document.createElement('div');
        studentItem.className = 'student-item';
        
        // Update test status based on current time
        if (test.startTime && test.endTime) {
          test.status = getTestStatus(new Date(test.startTime), new Date(test.endTime));
        }
        
        studentItem.innerHTML = `
          <div>
            <strong>${test.studentName}</strong> (${test.rollNumber})<br>
            <small>Class: ${test.className || 'N/A'} | Duration: ${test.duration} mins</small>
            <span class="test-status status-${test.status}">${test.status}</span>
          </div>
          <div>
            <button onclick="viewTestDetails(${test.id})">View</button>
            <button onclick="editStudentTest(${test.id})">Edit</button>
            <button onclick="deleteStudentTest(${test.id})" style="background-color: var(--danger-color); color: white;">Delete</button>
          </div>
        `;
        studentList.appendChild(studentItem);
      });
      
      // Update test schedule info if we're in student view
      if (document.getElementById('studentView').style.display === 'block') {
        updateTestScheduleInfo();
      }
    }
    
    function viewTestDetails(id) {
      const test = studentTests.find(t => t.id === id);
      if (!test) return;
      
      const modal = document.getElementById('testDetailsModal');
      const detailsDiv = document.getElementById('modalTestDetails');
      
      // Format dates
      const startDate = test.startTime ? new Date(test.startTime).toLocaleString() : 'Not scheduled';
      const endDate = test.endTime ? new Date(test.endTime).toLocaleString() : 'Not scheduled';
      const createdDate = new Date(test.createdAt).toLocaleString();
      const updatedDate = new Date(test.lastUpdated).toLocaleString();
      
      detailsDiv.innerHTML = `
        <p><strong>Student Name:</strong> ${test.studentName}</p>
        <p><strong>Roll Number:</strong> ${test.rollNumber}</p>
        <p><strong>Class:</strong> ${test.className || 'N/A'}</p>
        <p><strong>Email:</strong> ${test.email || 'N/A'}</p>
        <p><strong>Test Duration:</strong> ${test.duration} minutes</p>
        <p><strong>Start Time:</strong> ${startDate}</p>
        <p><strong>End Time:</strong> ${endDate}</p>
        <p><strong>Status:</strong> <span class="test-status status-${test.status}">${test.status}</span></p>
        <p><strong>Created At:</strong> ${createdDate}</p>
        <p><strong>Last Updated:</strong> ${updatedDate}</p>
        <p><strong>Test Password:</strong> ${'‚Ä¢'.repeat(test.password.length)}</p>
      `;
      
      modal.style.display = 'block';
      logActivity('Viewed test details', 'admin-action', { testId: id });
    }
    
    function closeModal() {
      document.getElementById('testDetailsModal').style.display = 'none';
    }
    
    function editStudentTest(id) {
      const test = studentTests.find(t => t.id === id);
      if (!test) return;
      
      document.getElementById('adminStudentName').value = test.studentName;
      document.getElementById('adminRollNumber').value = test.rollNumber;
      document.getElementById('adminClassName').value = test.className;
      document.getElementById('adminStudentEmail').value = test.email;
      document.getElementById('adminTestPassword').value = test.password;
      document.getElementById('adminDuration').value = test.duration;
      document.getElementById('adminPaperInput').value = test.testContent;
      document.getElementById('adminTestStartTime').value = test.startTime ? test.startTime.slice(0, 16) : '';
      document.getElementById('adminTestEndTime').value = test.endTime ? test.endTime.slice(0, 16) : '';
      
      // Scroll to form
      document.getElementById('addTestForm').scrollIntoView({ behavior: 'smooth' });
      
      // Remove the old test
      studentTests = studentTests.filter(t => t.id !== id);
      saveStudentTests();
      updateStudentList();

      logActivity('Editing test', 'admin-action', { testId: id });
    }
    
    function deleteStudentTest(id) {
      if (confirm("Are you sure you want to delete this student test?")) {
        studentTests = studentTests.filter(test => test.id !== id);
        saveStudentTests();
        updateStudentList();
        showAlert("Test deleted successfully!", "success");
        logActivity('Test deleted', 'admin-action', { testId: id });
      }
    }
    
    function filterTests() {
      const searchTerm = document.getElementById('searchTests').value.toLowerCase();
      const studentItems = document.querySelectorAll('.student-item');
      
      studentItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
      logActivity('Filtered tests', 'admin-action', { searchTerm });
    }
    
    function saveStudentTests() {
      localStorage.setItem('studentTests', JSON.stringify(studentTests));
      logActivity('Tests saved to storage', 'system');
    }
    
    function playAlertSound() {
      const sound = document.getElementById('alertSound');
      sound.currentTime = 0;
      sound.play().catch(e => console.log("Audio play failed:", e));
    }
    
    function playWarningSound() {
      const sound = document.getElementById('warningSound');
      sound.currentTime = 0;
      sound.play().catch(e => console.log("Audio play failed:", e));
    }
    
    function updateTestScheduleInfo() {
      const password = document.getElementById('studentTestPassword').value;
      const test = studentTests.find(t => t.password === password);
      const infoDiv = document.getElementById('testScheduleInfo');
      
      if (!test || !test.startTime || !test.endTime) {
        infoDiv.style.display = 'none';
        return;
      }
      
      const now = new Date();
      const startTime = new Date(test.startTime);
      const endTime = new Date(test.endTime);
      
      // Update test status
      test.status = getTestStatus(startTime, endTime);
      
      infoDiv.style.display = 'block';
      infoDiv.className = `test-schedule-info ${test.status}`;
      
      if (now < startTime) {
        // Test is scheduled for future
        const timeDiff = startTime - now;
        const hoursLeft = Math.floor(timeDiff / (1000 * 60 * 60));
        const minutesLeft = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const secondsLeft = Math.floor((timeDiff % (1000 * 60)) / 1000 );
        
        infoDiv.innerHTML = `
          <strong>Test Scheduled</strong><br>
          Starts in: ${hoursLeft}h ${minutesLeft}m ${secondsLeft}s<br>
          Start Time: ${startTime.toLocaleString()}<br>
          End Time: ${endTime.toLocaleString()}
        `;
      } else if (now > endTime) {
        // Test has ended
        infoDiv.innerHTML = `
          <strong>Test Completed</strong><br>
          The test time has ended at ${endTime.toLocaleString()}
        `;
      } else {
        // Test is active
        infoDiv.innerHTML = `
          <strong>Test Active</strong><br>
          Ends at: ${endTime.toLocaleString()}<br>
          ${test.duration} minutes duration
        `;
        
        // If password is entered but test not started, show start button
        if (password && !testActive) {
          document.getElementById('studentStartBtn').style.display = 'flex';
        }
      }
    }
    
    function checkAutoStartTests() {
      const now = new Date();
      const passwordInput = document.getElementById('studentTestPassword');
      
      // Check if we're already in the student view with a test running
      if (document.getElementById('studentView').style.display === 'block' && testActive) {
        return;
      }
      
      // Find tests that should be active now
      const activeTests = studentTests.filter(test => {
        if (!test.startTime || !test.endTime) return false;
        
        const start = new Date(test.startTime);
        const end = new Date(test.endTime);
        
        // Test should be active if current time is between start and end
        return now >= start && now <= end;
      });
      
      // If there's exactly one active test, auto-fill and start it
      if (activeTests.length === 1) {
        const test = activeTests[0];
        passwordInput.value = test.password;
        startStudentTest();
        logActivity('Test auto-started based on schedule', 'system', { testId: test.id });
      }
    }
    
    function startStudentTest() {
      const password = document.getElementById('studentTestPassword').value;
      const test = studentTests.find(t => t.password === password);
      
      if (!test) {
        showAlert("Invalid test password!");
        logActivity('Failed test start - invalid password', 'student-action');
        return;
      }
      
      currentTest = test;
      
      // Check test schedule if set
      if (test.startTime && test.endTime) {
        const now = new Date();
        testStartTime = new Date(test.startTime);
        testEndTime = new Date(test.endTime);
        
        if (now < testStartTime) {
          showAlert(`Test cannot be started before ${testStartTime.toLocaleString()}`);
          logActivity('Failed test start - before scheduled time', 'student-action', { 
            currentTime: now.toISOString(),
            scheduledStart: testStartTime.toISOString()
          });
          return;
        }
        
        if (now > testEndTime) {
          showAlert(`Test time has ended at ${testEndTime.toLocaleString()}`);
          logActivity('Failed test start - after scheduled time', 'student-action', { 
            currentTime: now.toISOString(),
            scheduledEnd: testEndTime.toISOString()
          });
          return;
        }
      }
      
      // Hide admin view button
      document.getElementById('adminViewBtn').style.display = 'none';
      
      document.getElementById('testContent').innerText = test.testContent;
      document.getElementById('testWindow').style.display = 'block';
      document.querySelector('#studentView .form-section').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'flex';
      
      // Display student info
      document.getElementById('studentInfoDisplay').innerHTML = `
        <strong>üë§ ${test.studentName}</strong> | 
        <strong>üé´ ${test.rollNumber}</strong> | 
        <strong>üè´ ${test.className || 'N/A'}</strong>
      `;
      
      // Show security warning
      document.getElementById('securityWarning').style.display = 'block';
      
      // Enter fullscreen
      const elem = document.documentElement;
      if (elem.requestFullscreen) {
        elem.requestFullscreen().catch(err => {
          showAlert(`Fullscreen error: ${err.message}`);
          logActivity('Fullscreen error', 'system', { error: err.message });
        });
      } else if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen();
      } else if (elem.msRequestFullscreen) {
        elem.msRequestFullscreen();
      }
      
      testActive = true;
      startTime = new Date();
      totalTime = test.duration * 60;
      timeLeft = totalTime;
      updateTimerDisplay(timeLeft);
      updateCurrentTime();
      updateProgressBar();
      
      countdown = setInterval(() => {
        timeLeft--;
        updateTimerDisplay(timeLeft);
        updateCurrentTime();
        updateProgressBar();
        
        if (timeLeft <= 0) {
          endTest("‚è∞ Time's Up! Test has been automatically submitted.", true);
        }
      }, 1000);
      
      // Set up visibility change detection
      document.addEventListener('visibilitychange', handleVisibilityChange);
      window.addEventListener('blur', handleWindowBlur);
      document.addEventListener('fullscreenchange', checkFullscreenExit);
      document.addEventListener('webkitfullscreenchange', checkFullscreenExit);
      document.addEventListener('mozfullscreenchange', checkFullscreenExit);
      document.addEventListener('MSFullscreenChange', checkFullscreenExit);
      
      // Check test schedule if set
      if (testStartTime && testEndTime) {
        scheduleCheckInterval = setInterval(() => {
          const now = new Date();
          if (now > testEndTime) {
            endTest("‚è∞ Scheduled test time has ended. Test auto-submitted.", true);
          }
        }, 60000); // Check every minute
      }
      
      // Disable right-click to prevent copy-paste
      document.addEventListener('contextmenu', preventRightClick);
      
      // Disable keyboard shortcuts
      document.addEventListener('keydown', preventShortcuts);

      // Log test start
      logActivity('Test started', 'student-action', { 
        testId: test.id,
        studentName: test.studentName,
        rollNumber: test.rollNumber
      });
    }
    
    function preventRightClick(e) {
      if (testActive) {
        e.preventDefault();
        showWarning("Right-click is disabled during the test.");
        logActivity('Right-click attempted', 'security', { 
          action: 'contextmenu',
          testId: currentTest.id
        });
      }
    }
    
    function preventShortcuts(e) {
      if (testActive) {
        // Disable F5, F11, F12, Ctrl+R, Ctrl+Shift+R, Ctrl+W, Alt+Tab, etc.
        const forbiddenKeys = [116, 122, 123]; // F5, F11, F12
        const forbiddenCombos = [
          e.ctrlKey && e.keyCode === 82,  // Ctrl+R
          e.ctrlKey && e.keyCode === 87,  // Ctrl+W
          e.altKey && e.keyCode === 9,    // Alt+Tab
          e.ctrlKey && e.shiftKey && e.keyCode === 82 // Ctrl+Shift+R
        ];
        
        if (forbiddenKeys.includes(e.keyCode) || forbiddenCombos.some(combo => combo)) {
          e.preventDefault();
          showWarning("This keyboard shortcut is disabled during the test.");
          logActivity('Restricted shortcut attempted', 'security', { 
            keyCode: e.keyCode,
            ctrlKey: e.ctrlKey,
            shiftKey: e.shiftKey,
            altKey: e.altKey,
            testId: currentTest.id
          });
        }
      }
    }
    
    function submitTest() {
      if (confirm("Are you sure you want to submit the test now?")) {
        endTest("‚úÖ Test submitted successfully!", true);
        logActivity('Test submitted manually', 'student-action', { 
          testId: currentTest.id,
          timeLeft: timeLeft
        });
      }
    }
    
    function handleVisibilityChange() {
      if (document.hidden && testActive) {
        tabSwitchCount++;
        if (tabSwitchCount >= MAX_TAB_SWITCHES) {
          endTest(`üö´ Test auto-submitted. You switched tabs/windows ${MAX_TAB_SWITCHES} times.`, true);
          logActivity('Test auto-submitted - max tab switches reached', 'security', { 
            testId: currentTest.id,
            tabSwitchCount: tabSwitchCount
          });
        } else {
          const remainingSwitches = MAX_TAB_SWITCHES - tabSwitchCount;
          const warningMsg = 
            `Warning: You switched tabs/windows (${tabSwitchCount}/${MAX_TAB_SWITCHES}). ${remainingSwitches} more attempts allowed.`;
          document.getElementById('fsWarning').innerText = warningMsg;
          showWarning(warningMsg);
          playWarningSound();
          logActivity('Tab/window switch detected', 'security', { 
            testId: currentTest.id,
            tabSwitchCount: tabSwitchCount,
            remainingSwitches: remainingSwitches
          });
        }
      }
    }
    
    function handleWindowBlur() {
      if (testActive) {
        document.getElementById('fsWarning').innerText = 
          "Warning: The test window lost focus. Don't switch applications!";
        logActivity('Window focus lost', 'security', { 
          testId: currentTest.id
        });
      }
    }
    
    function updateTimerDisplay(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      document.getElementById('timer').innerHTML = 
        `<span>‚è± Time Left:</span> <span style="font-size:1.2em">${min}:${sec < 10 ? '0' : ''}${sec}</span>`;
    }
    
    function updateProgressBar() {
      const progressPercent = (timeLeft / totalTime) * 100;
      document.getElementById('progressBar').style.width = `${progressPercent}%`;
      
      // Change color based on remaining time
      if (progressPercent < 20) {
        document.getElementById('progressBar').style.backgroundColor = 'var(--danger-color)';
      } else if (progressPercent < 50) {
        document.getElementById('progressBar').style.backgroundColor = 'var(--warning-color)';
      }
    }
    
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      document.getElementById('currentTime').innerHTML = 
        `<span>üïí Current Time:</span> <span style="font-size:1.1em">${timeString}</span>`;
    }
    
    function checkFullscreenExit() {
      if (!isFullscreen() && testActive) {
        endTest("üö´ Test auto-submitted because you exited full screen mode.", true);
        logActivity('Test auto-submitted - fullscreen exited', 'security', { 
          testId: currentTest.id
        });
      }
    }
    
    function isFullscreen() {
      return !!(document.fullscreenElement || 
               document.webkitFullscreenElement || 
               document.mozFullScreenElement || 
               document.msFullscreenElement);
    }
    
    function endTest(message, playSound = false) {
      clearInterval(countdown);
      clearInterval(scheduleCheckInterval);
      testActive = false;
      
      if (playSound) {
        playAlertSound();
      }
      
      // Hide security warning
      document.getElementById('securityWarning').style.display = 'none';
      
      // Calculate time taken
      const endTime = new Date();
      const timeTaken = Math.round((endTime - startTime) / 1000);
      const minutesTaken = Math.floor(timeTaken / 60);
      const secondsTaken = timeTaken % 60;
      
      document.getElementById('testWindow').innerHTML = `
        <h2>${message}</h2>
        <div class="test-results">
          <div class="result-item">
            <strong>Student:</strong> ${currentTest.studentName}
          </div>
          <div class="result-item">
            <strong>Roll Number:</strong> ${currentTest.rollNumber}
          </div>
          <div class="result-item">
            <strong>Class:</strong> ${currentTest.className || 'N/A'}
          </div>
          <div class="result-item">
            <strong>Time taken:</strong> ${minutesTaken}m ${secondsTaken}s
          </div>
          <div class="result-item">
            <strong>Tab/window switches:</strong> ${tabSwitchCount}
          </div>
          <div class="result-item">
            <strong>Test completed at:</strong> ${endTime.toLocaleString()}
          </div>
        </div>
        <button onclick="resetStudentView()" style="margin-top: 20px; display: block; margin-left: auto; margin-right: auto;">Return to Test Login</button>
      `;
      
      exitFullscreen();
      cleanupEventListeners();

      // Update test status
      if (currentTest) {
        currentTest.status = 'completed';
        currentTest.lastUpdated = new Date().toISOString();
        saveStudentTests();
        updateStudentList();
      }

      logActivity('Test ended', 'student-action', { 
        testId: currentTest.id,
        reason: message,
        timeTaken: timeTaken,
        tabSwitchCount: tabSwitchCount
      });
    }
    
    function resetStudentView() {
      // Clear any existing intervals
      clearInterval(countdown);
      clearInterval(scheduleCheckInterval);
      
      // Reset variables
      testActive = false;
      timeLeft = 0;
      tabSwitchCount = 0;
      testStartTime = null;
      testEndTime = null;
      currentTest = null;
      
      // Reset form
      document.getElementById('studentTestPassword').value = '';
      
      // Show login form
      document.querySelector('#studentView .form-section').style.display = 'block';
      document.getElementById('testWindow').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'none';
      document.getElementById('testScheduleInfo').style.display = 'none';
      document.getElementById('securityWarning').style.display = 'none';
      
      // Reset progress bar
      document.getElementById('progressBar').style.width = '100%';
      document.getElementById('progressBar').style.backgroundColor = 'var(--success-color)';
      
      // Show admin view button again
      document.getElementById('adminViewBtn').style.display = 'flex';
      
      // Exit fullscreen if still in it
      exitFullscreen();
      cleanupEventListeners();
      logActivity('Student view reset', 'navigation');
    }
    
    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
    
    function cleanupEventListeners() {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('blur', handleWindowBlur);
      document.removeEventListener('fullscreenchange', checkFullscreenExit);
      document.removeEventListener('webkitfullscreenchange', checkFullscreenExit);
      document.removeEventListener('mozfullscreenchange', checkFullscreenExit);
      document.removeEventListener('MSFullscreenChange', checkFullscreenExit);
      document.removeEventListener('contextmenu', preventRightClick);
      document.removeEventListener('keydown', preventShortcuts);
    }
    
    function showAlert(message, type = 'error') {
      // Create alert element
      const alertDiv = document.createElement('div');
      alertDiv.style.position = 'fixed';
      alertDiv.style.top = '20px';
      alertDiv.style.left = '50%';
      alertDiv.style.transform = 'translateX(-50%)';
      alertDiv.style.padding = '15px 25px';
      alertDiv.style.borderRadius = '8px';
      alertDiv.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
      alertDiv.style.zIndex = '1000';
      alertDiv.style.maxWidth = '90%';
      alertDiv.style.textAlign = 'center';
      alertDiv.style.fontWeight = 'bold';
      
      if (type === 'error') {
        alertDiv.style.backgroundColor = 'var(--danger-color)';
        alertDiv.style.color = 'white';
      } else {
        alertDiv.style.backgroundColor = 'var(--success-color)';
        alertDiv.style.color = 'white';
      }
      
      alertDiv.textContent = message;
      document.body.appendChild(alertDiv);
      
      // Remove after 3 seconds
      setTimeout(() => {
        alertDiv.style.transition = 'opacity 0.5s';
        alertDiv.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(alertDiv);
        }, 500);
      }, 3000);
    }
    
    function showWarning(message) {
      const warningBox = document.createElement('div');
      warningBox.className = 'warning-box';
      warningBox.textContent = message;
      
      // Insert at the top of the test window
      const testWindow = document.getElementById('testWindow');
      if (testWindow) {
        testWindow.insertBefore(warningBox, testWindow.firstChild);
        
        // Remove after 5 seconds
        setTimeout(() => {
          warningBox.style.transition = 'opacity 0.5s';
          warningBox.style.opacity = '0';
          setTimeout(() => {
            warningBox.remove();
          }, 500);
        }, 5000);
      }
    }

    function logActivity(action, category, details = {}) {
      const activity = {
        timestamp: new Date().toISOString(),
        action,
        category,
        details
      };
      
      activityLog.push(activity);
      
      // Keep only the last 100 activities
      if (activityLog.length > 100) {
        activityLog.shift();
      }
      
      // For demo purposes, we'll log to console
      console.log('Activity:', activity);
    }

    function exportAllTests() {
      const dataStr = JSON.stringify(studentTests, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportName = `student-tests-${new Date().toISOString().slice(0,10)}.json`;
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportName);
      linkElement.click();
      
      logActivity('Exported all tests', 'admin-action');
    }

    function importTests() {
      document.getElementById('importModal').style.display = 'block';
      logActivity('Import tests dialog opened', 'admin-action');
    }

    function closeImportModal() {
      document.getElementById('importModal').style.display = 'none';
    }

    function processImport() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        showAlert("Please select a file to import");
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const importedTests = JSON.parse(e.target.result);
          
          if (!Array.isArray(importedTests)) {
            throw new Error("Invalid file format - expected an array of tests");
          }
          
          if (confirm(`Import ${importedTests.length} tests? This will overwrite existing tests with matching IDs.`)) {
            // Merge imported tests with existing ones
            importedTests.forEach(importedTest => {
              // Remove existing test with same ID if it exists
              studentTests = studentTests.filter(test => test.id !== importedTest.id);
              studentTests.push(importedTest);
            });
            
            saveStudentTests();
            updateStudentList();
            showAlert(`Successfully imported ${importedTests.length} tests`, "success");
            closeImportModal();
            
            logActivity('Tests imported', 'admin-action', { count: importedTests.length });
          }
        } catch (error) {
          showAlert(`Error importing tests: ${error.message}`);
          logActivity('Import failed', 'admin-action', { error: error.message });
        }
      };
      reader.readAsText(file);
    }

    function clearAllTests() {
      if (confirm("Are you sure you want to delete ALL tests? This action cannot be undone.")) {
        studentTests = [];
        saveStudentTests();
        updateStudentList();
        showAlert("All tests have been deleted", "success");
        logActivity('All tests cleared', 'admin-action');
      }
    }

    function generateSampleData() {
      if (confirm("Generate sample test data? This will add 5 sample tests to the system.")) {
        const sampleTests = [
          {
            id: Date.now(),
            studentName: "John Doe",
            rollNumber: "S1001",
            className: "Computer Science",
            email: "john.doe@example.com",
            password: "test123",
            duration: 30,
            testContent: "Sample test questions for John Doe:\n\n1. What is the capital of France?\n2. Solve for x: 2x + 5 = 15\n3. Explain the concept of OOP.",
            startTime: new Date(Date.now() + 3600000).toISOString().slice(0, 16),
            endTime: new Date(Date.now() + 5400000).toISOString().slice(0, 16),
            createdAt: new Date().toISOString(),
            status: "scheduled",
            lastUpdated: new Date().toISOString()
          },
          {
            id: Date.now() + 1,
            studentName: "Jane Smith",
            rollNumber: "S1002",
            className: "Mathematics",
            email: "jane.smith@example.com",
            password: "math456",
            duration: 45,
            testContent: "Mathematics Test:\n\n1. Differentiate x^2 + 3x + 2\n2. Integrate sin(x)\n3. Solve the quadratic equation x^2 - 5x + 6 = 0",
            startTime: new Date(Date.now() - 3600000).toISOString().slice(0, 16),
            endTime: new Date(Date.now() + 3600000).toISOString().slice(0, 16),
            createdAt: new Date().toISOString(),
            status: "active",
            lastUpdated: new Date().toISOString()
          },
          {
            id: Date.now() + 2,
            studentName: "Alice Johnson",
            rollNumber: "S1003",
            className: "Physics",
            email: "alice.j@example.com",
            password: "physics789",
            duration: 60,
            testContent: "Physics Exam:\n\n1. State Newton's laws of motion\n2. Calculate the force needed to accelerate a 5kg object at 2m/s¬≤\n3. Explain the photoelectric effect",
            startTime: new Date(Date.now() - 7200000).toISOString().slice(0, 16),
            endTime: new Date(Date.now() - 3600000).toISOString().slice(0, 16),
            createdAt: new Date().toISOString(),
            status: "completed",
            lastUpdated: new Date().toISOString()
          },
          {
            id: Date.now() + 3,
            studentName: "Bob Williams",
            rollNumber: "S1004",
            className: "History",
            email: "bob.w@example.com",
            password: "history101",
            duration: 20,
            testContent: "History Quiz:\n\n1. When did World War II end?\n2. Who was the first president of the United States?\n3. Name three ancient civilizations",
            createdAt: new Date().toISOString(),
            status: "active",
            lastUpdated: new Date().toISOString()
          },
          {
            id: Date.now() + 4,
            studentName: "Charlie Brown",
            rollNumber: "S1005",
            className: "Chemistry",
            email: "charlie.b@example.com",
            password: "chem202",
            duration: 90,
            testContent: "Chemistry Final:\n\n1. Balance the equation: H2 + O2 ‚Üí H2O\n2. Define Avogadro's number\n3. Explain the difference between ionic and covalent bonds",
            startTime: new Date(Date.now() + 86400000).toISOString().slice(0, 16),
            endTime: new Date(Date.now() + 90000000).toISOString().slice(0, 16),
            createdAt: new Date().toISOString(),
            status: "scheduled",
            lastUpdated: new Date().toISOString()
          }
        ];

        sampleTests.forEach(test => {
          studentTests.push(test);
        });

        saveStudentTests();
        updateStudentList();
        showAlert("5 sample tests generated successfully!", "success");
        logActivity('Sample data generated', 'admin-action', { count: 5 });
      }
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('testDetailsModal');
      if (event.target == modal) {
        closeModal();
      }
      
      const importModal = document.getElementById('importModal');
      if (event.target == importModal) {
        closeImportModal();
      }
    }
  </script>
</body>
</html>