<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Advanced Secure Examination System</title>
  <style>
    :root {
      --primary-color: #4361ee;
      --primary-dark: #3a56d4;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --danger-color: #f72585;
      --warning-color: #f8961e;
      --info-color: #4895ef;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --text-color: #333;
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.1);
      --input-bg: #f8f9fa;
      --modal-bg: #ffffff;
      --transition-time: 0.2s;
    }

    .dark-mode {
      --primary-color: #4895ef;
      --primary-dark: #3a56d4;
      --secondary-color: #4361ee;
      --text-color: #f8f9fa;
      --bg-color: #121212;
      --card-bg: #1e1e1e;
      --border-color: #333;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --input-bg: #2d2d2d;
      --modal-bg: #252525;
      --light-color: #2d2d2d;
    }

    * {
      box-sizing: border-box;
      transition: background-color var(--transition-time), color var(--transition-time), border-color var(--transition-time);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      margin: 0;
      padding: 0;
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1000px;
      margin: 20px auto;
      padding: 30px;
      background: var(--card-bg);
      border: 2px solid var(--primary-color);
      box-shadow: 0 10px 25px var(--shadow-color);
      border-radius: 15px;
    }

    h2 {
      text-align: center;
      color: var(--primary-color);
      margin-bottom: 20px;
    }

    .form-section {
      margin-bottom: 25px;
      padding: 20px;
      background: var(--light-color);
      border-radius: 10px;
      border: 1px solid var(--border-color);
    }

    .form-section h3 {
      margin-top: 0;
      color: var(--primary-color);
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    #paperInput, #adminPaperInput {
      width: 100%;
      height: 200px;
      padding: 15px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      background-color: var(--input-bg);
      resize: vertical;
      transition: border-color var(--transition-time);
      color: var(--text-color);
      font-family: inherit;
    }

    #paperInput:focus, #adminPaperInput:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    label {
      font-weight: bold;
      display: block;
      margin: 15px 0 5px;
      color: var(--text-color);
    }

    .input-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    input[type="text"],
    input[type="number"],
    input[type="password"],
    input[type="datetime-local"],
    select {
      padding: 10px;
      font-size: 16px;
      border: 2px solid var(--border-color);
      border-radius: 10px;
      width: 100%;
      background-color: var(--input-bg);
      transition: border-color var(--transition-time);
      color: var(--text-color);
      font-family: inherit;
    }

    input:focus, select:focus {
      border-color: var(--primary-color);
      outline: none;
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 20px;
      flex-wrap: wrap;
    }

    button {
      padding: 12px 30px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all var(--transition-time) ease;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      font-family: inherit;
    }

    #startBtn, #studentStartBtn {
      background-color: var(--success-color);
      color: white;
    }

    #startBtn:hover, #studentStartBtn:hover {
      background-color: #3aa8d8;
      transform: scale(1.03);
    }

    #resetBtn {
      background-color: var(--light-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
    }

    #resetBtn:hover {
      background-color: var(--border-color);
      transform: scale(1.03);
    }

    #submitBtn {
      background-color: var(--primary-color);
      color: white;
      display: none;
    }

    #submitBtn:hover {
      background-color: var(--primary-dark);
      transform: scale(1.03);
    }

    #testWindow {
      display: none;
      background-color: var(--card-bg);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 25px;
      margin-top: 30px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: inset 0 0 10px var(--shadow-color);
    }

    #timer {
      font-size: 24px;
      font-weight: bold;
      color: var(--danger-color);
      padding: 10px;
      background: rgba(220, 53, 69, 0.1);
      border: 2px dashed rgba(220, 53, 69, 0.3);
      border-radius: 10px;
      text-align: center;
      margin-bottom: 20px;
    }

    #instruction {
      color: var(--primary-color);
      background: rgba(67, 97, 238, 0.1);
      padding: 15px;
      border: 1px solid rgba(67, 97, 238, 0.3);
      border-radius: 10px;
      margin-bottom: 15px;
      font-weight: bold;
      text-align: center;
      line-height: 1.5;
    }

    #testContent {
      font-size: 18px;
      line-height: 1.6;
      white-space: pre-wrap;
      padding: 20px;
      border: 2px solid var(--border-color);
      background: var(--light-color);
      border-radius: 10px;
      overflow-wrap: break-word;
    }

    .statusBar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      font-size: 16px;
      font-weight: bold;
      flex-wrap: wrap;
      gap: 10px;
    }

    .fullscreen-warning {
      color: var(--danger-color);
      font-size: 14px;
      text-align: center;
      margin-top: 15px;
      font-style: italic;
      padding: 10px;
      background-color: rgba(220, 53, 69, 0.1);
      border-radius: 5px;
    }

    .warning-box {
      background-color: rgba(248, 215, 218, 0.3);
      border-left: 4px solid var(--danger-color);
      padding: 15px;
      margin: 15px 0;
      border-radius: 0 5px 5px 0;
      color: var(--text-color);
      animation: fadeIn 0.3s ease-in-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .progress-container {
      width: 100%;
      height: 10px;
      background-color: var(--border-color);
      border-radius: 5px;
      margin: 15px 0;
    }

    .progress-bar {
      height: 100%;
      border-radius: 5px;
      background-color: var(--success-color);
      width: 100%;
      transition: width 1s linear;
    }

    .test-actions {
      display: flex;
      justify-content: center;
      margin-top: 20px;
      gap: 15px;
    }

    .student-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .test-schedule {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .auth-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .admin-panel {
      display: none;
      margin-bottom: 30px;
    }

    .student-view {
      display: none;
    }

    .switch-view {
      text-align: center;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .switch-view-buttons {
      display: flex;
      gap: 10px;
    }

    .switch-view button {
      background-color: #6c757d;
      color: white;
    }

    .switch-view button:hover {
      background-color: #5a6268;
    }

    .student-list {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid var(--border-color);
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
    }

    .student-item {
      padding: 10px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .student-item:last-child {
      border-bottom: none;
    }

    .student-item button {
      padding: 5px 10px;
      font-size: 14px;
    }

    .logout-btn {
      background-color: var(--danger-color);
      color: white;
      margin-top: 15px;
    }

    .logout-btn:hover {
      background-color: #d61a58;
    }

    .admin-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .test-status {
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-scheduled {
      background-color: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }

    .status-active {
      background-color: rgba(40, 167, 69, 0.2);
      color: #28a745;
    }

    .status-completed {
      background-color: rgba(220, 53, 69, 0.2);
      color: #dc3545;
    }

    .status-expired {
      background-color: rgba(108, 117, 125, 0.2);
      color: #6c757d;
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeInModal 0.3s ease-in-out;
    }

    @keyframes fadeInModal {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .modal-content {
      background-color: var(--modal-bg);
      margin: 10% auto;
      padding: 30px;
      border-radius: 10px;
      max-width: 600px;
      box-shadow: 0 5px 15px var(--shadow-color);
      position: relative;
      animation: slideIn 0.3s ease-in-out;
    }

    @keyframes slideIn {
      from { transform: translateY(-20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .close-modal {
      position: absolute;
      top: 15px;
      right: 15px;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: #aaa;
    }

    .close-modal:hover {
      color: var(--text-color);
    }

    .test-details {
      margin-top: 20px;
    }

    .test-details p {
      margin: 10px 0;
    }

    .test-details strong {
      display: inline-block;
      width: 150px;
    }

    .test-countdown {
      margin-top: 10px;
      padding: 10px;
      background-color: rgba(67, 97, 238, 0.1);
      border-radius: 5px;
      text-align: center;
      font-weight: bold;
    }

    .dark-mode-toggle {
      background: transparent;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--text-color);
      padding: 5px;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dark-mode-toggle:hover {
      background-color: var(--border-color);
    }

    .test-schedule-info {
      margin-top: 10px;
      padding: 10px;
      background-color: rgba(67, 97, 238, 0.1);
      border-radius: 5px;
      font-size: 14px;
      text-align: center;
      animation: fadeIn 0.3s ease-in-out;
    }

    .test-schedule-info.active {
      background-color: rgba(40, 167, 69, 0.1);
    }

    .test-schedule-info.scheduled {
      background-color: rgba(255, 193, 7, 0.1);
    }

    .test-schedule-info.completed {
      background-color: rgba(220, 53, 69, 0.1);
    }

    .alert {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 90%;
      text-align: center;
      font-weight: bold;
      animation: slideIn 0.3s ease-in-out;
    }

    .alert-error {
      background-color: var(--danger-color);
      color: white;
    }

    .alert-success {
      background-color: var(--success-color);
      color: white;
    }

    .alert-warning {
      background-color: var(--warning-color);
      color: white;
    }

    .confirmation-modal {
      display: none;
      position: fixed;
      z-index: 1001;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .confirmation-content {
      background-color: var(--modal-bg);
      margin: 20% auto;
      padding: 30px;
      border-radius: 10px;
      max-width: 500px;
      box-shadow: 0 5px 15px var(--shadow-color);
      position: relative;
      text-align: center;
    }

    .confirmation-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 20px;
    }

    .confirmation-buttons button {
      min-width: 100px;
    }

    .confirmation-buttons button:first-child {
      background-color: var(--danger-color);
    }

    .confirmation-buttons button:last-child {
      background-color: var(--success-color);
    }

    .loading-spinner {
      display: none;
      position: fixed;
      z-index: 1002;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--primary-color);
      animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .test-history {
      margin-top: 30px;
    }

    .history-item {
      padding: 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      margin-bottom: 10px;
      background-color: var(--light-color);
    }

    .history-item h4 {
      margin-top: 0;
      color: var(--primary-color);
    }

    .history-meta {
      display: flex;
      justify-content: space-between;
      font-size: 14px;
      color: var(--text-color);
      opacity: 0.8;
    }

    .copy-btn {
      background-color: var(--info-color);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }

    .copy-btn:hover {
      background-color: #3a7bd5;
    }

    .test-import-export {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .test-import-export button {
      padding: 10px 15px;
    }

    @media (max-width: 768px) {
      .container {
        padding: 20px;
        margin: 10px;
      }
      
      .statusBar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      button {
        width: 100%;
        padding: 15px 30px;
        font-size: 18px;
      }

      #paperInput, #adminPaperInput {
        font-size: 18px;
      }

      #timer, #currentTime {
        font-size: 20px;
      }

      #instruction {
        font-size: 18px;
      }

      #testContent {
        font-size: 20px;
      }

      .student-info,
      .test-schedule,
      .auth-section {
        grid-template-columns: 1fr;
      }

      .modal-content {
        margin: 20% auto;
        width: 90%;
      }

      .switch-view {
        flex-direction: column;
        gap: 10px;
      }

      .switch-view-buttons {
        width: 100%;
        justify-content: space-between;
      }

      .confirmation-content {
        width: 90%;
        margin: 30% auto;
      }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="switch-view">
      <div class="switch-view-buttons">
        <button id="adminViewBtn" onclick="showAdminView()">Admin Panel</button>
        <button id="studentViewBtn" onclick="showStudentView()">Student View</button>
      </div>
      <button id="darkModeToggle" class="dark-mode-toggle" onclick="toggleDarkMode()">🌓</button>
    </div>
    
    <!-- Admin Panel Section -->
    <div id="adminPanel" class="admin-panel">
      <h2>🔐 Admin Panel</h2>
      
      <div class="form-section">
        <h3>Admin Authentication</h3>
        <div id="adminLoginForm">
          <label for="adminPassword">Admin Password:</label>
          <input type="password" id="adminPassword" placeholder="Enter admin password">
          <button onclick="authenticateAdmin()">Login</button>
        </div>
        <div id="adminControls" style="display: none;">
          <div class="admin-actions">
            <button onclick="showAddTestForm()">➕ Add New Test</button>
            <button class="logout-btn" onclick="adminLogout()">🔒 Logout</button>
          </div>
        </div>
      </div>
      
      <div id="adminMainControls" style="display: none;">
        <div class="form-section" id="addTestForm">
          <h3>📝 Create Student Test</h3>
          <div class="student-info">
            <div>
              <label for="adminStudentName">Full Name:</label>
              <input type="text" id="adminStudentName" placeholder="Enter student full name">
            </div>
            <div>
              <label for="adminRollNumber">Roll Number:</label>
              <input type="text" id="adminRollNumber" placeholder="Enter roll number">
            </div>
            <div>
              <label for="adminClassName">Class/Group:</label>
              <input type="text" id="adminClassName" placeholder="Enter class">
            </div>
            <div>
              <label for="adminStudentEmail">Email:</label>
              <input type="text" id="adminStudentEmail" placeholder="Enter email">
            </div>
          </div>
          
          <div class="test-schedule">
            <div>
              <label for="adminTestStartTime">Start Time:</label>
              <input type="datetime-local" id="adminTestStartTime">
            </div>
            <div>
              <label for="adminTestEndTime">End Time:</label>
              <input type="datetime-local" id="adminTestEndTime">
            </div>
          </div>
          
          <div>
            <label for="adminTestPassword">Test Password:</label>
            <input type="password" id="adminTestPassword" placeholder="Set test password">
            <small style="color: var(--text-color); opacity: 0.7;">(Students will need this to access their test)</small>
          </div>
          
          <div>
            <label for="adminDuration">Test Duration (minutes):</label>
            <input type="number" id="adminDuration" min="1" max="180" value="30">
          </div>
          
          <div>
            <label for="adminPaperInput">Test Content:</label>
            <textarea id="adminPaperInput" placeholder="Enter test questions here..."></textarea>
          </div>
          
          <div class="test-import-export">
            <button onclick="importTestData()">📥 Import Test</button>
            <button onclick="exportTestData()">📤 Export Test</button>
            <button onclick="generateRandomTest()">🎲 Generate Random</button>
          </div>
          
          <div class="button-group">
            <button onclick="addStudentTest()">Save Test</button>
            <button id="resetBtn" onclick="resetTestForm()">Reset Form</button>
          </div>
        </div>
        
        <div class="form-section">
          <h3>👥 Student Tests List</h3>
          <div class="input-group">
            <input type="text" id="searchTests" placeholder="Search by name, roll number or class..." oninput="debounceFilterTests()">
            <button onclick="filterTests()">🔍 Search</button>
            <button onclick="clearSearch()">🗑️ Clear</button>
          </div>
          <div class="student-list" id="studentList">
            <!-- Student items will be added here dynamically -->
          </div>
        </div>

        <div class="form-section test-history">
          <h3>📜 Test History</h3>
          <div id="testHistory">
            <!-- Test history items will be added here -->
          </div>
        </div>
      </div>
    </div>
    
    <!-- Student View Section -->
    <div id="studentView" class="student-view">
      <h2>📝 Examination Window</h2>
      
      <div class="form-section">
        <h3>🔒 Test Authentication</h3>
        <div>
          <label for="studentTestPassword">Test Password:</label>
          <input type="password" id="studentTestPassword" placeholder="Enter your test password">
          <small style="color: var(--text-color); opacity: 0.7;">(Provided by your instructor)</small>
        </div>
        <div id="testScheduleInfo" class="test-schedule-info" style="display: none;"></div>
        <div class="button-group">
          <button id="studentStartBtn" onclick="startStudentTest()">
            <span class="icon">🚀</span>
            <span class="text">Start Test</span>
          </button>
          <button id="resetBtn" onclick="resetStudentView()">
            <span class="icon">🔄</span>
            <span class="text">Reset</span>
          </button>
        </div>
      </div>
      
      <div id="testWindow">
        <div class="statusBar">
          <div id="studentInfoDisplay"></div>
          <div id="currentTime"></div>
        </div>
        <div id="timer">Time Left: 30:00</div>
        <div class="progress-container">
          <div id="progressBar" class="progress-bar"></div>
        </div>
        <div id="instruction">
          ⚠️ Examination in Progress - Strictly follow these rules:<br>
          1. Do not exit full screen or switch tabs/windows<br>
          2. Do not use any other applications<br>
          3. The test will be automatically submitted if rules are violated
        </div>
        <div id="testContent"></div>
        <div class="test-actions">
          <button id="submitBtn" onclick="showSubmitConfirmation()">
            <span class="icon">✅</span>
            <span class="text">Submit Test</span>
          </button>
        </div>
        <div class="fullscreen-warning" id="fsWarning"></div>
      </div>
    </div>
  </div>

  <!-- Test Details Modal -->
  <div id="testDetailsModal" class="modal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeModal()">&times;</span>
      <h3>Test Details</h3>
      <div class="test-details" id="modalTestDetails">
        <!-- Details will be populated here -->
      </div>
      <button onclick="closeModal()" style="margin-top: 20px;">Close</button>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="confirmation-modal">
    <div class="confirmation-content">
      <h3 id="confirmationTitle">Confirm Action</h3>
      <p id="confirmationMessage">Are you sure you want to perform this action?</p>
      <div class="confirmation-buttons">
        <button id="confirmActionBtn">Confirm</button>
        <button id="cancelActionBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="loading-spinner">
    <div class="spinner"></div>
  </div>

  <audio id="alertSound" src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" preload="auto"></audio>
  <audio id="warningSound" src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-991.mp3" preload="auto"></audio>

  <script>
    // Performance optimization variables
    let countdown;
    let testActive = false;
    let timeLeft;
    let totalTime;
    let startTime;
    let tabSwitchCount = 0;
    const MAX_TAB_SWITCHES = 3;
    let testStartTime, testEndTime;
    let scheduleCheckInterval;
    const ADMIN_PASSWORD = "admin123";
    let isAdminLoggedIn = false;
    let autoStartCheckInterval;
    let currentTest = null;
    let testScheduleInterval;
    let debounceTimer;
    const DEBOUNCE_DELAY = 300;
    
    // Student test database
    let studentTests = JSON.parse(localStorage.getItem('studentTests')) || [];
    let testHistory = JSON.parse(localStorage.getItem('testHistory')) || [];
    
    // Initialize views
    document.addEventListener('DOMContentLoaded', function() {
      // Check for saved dark mode preference
      if (localStorage.getItem('darkMode') === 'enabled') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeToggle').textContent = '🌞';
      }
      
      showAdminView();
      updateStudentList();
      updateTestHistory();
      
      // Set default test time to current time + 1 hour
      const now = new Date();
      const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
      
      document.getElementById('adminTestStartTime').value = now.toISOString().slice(0, 16);
      document.getElementById('adminTestEndTime').value = oneHourLater.toISOString().slice(0, 16);
      
      updateCurrentTime();
      setInterval(updateCurrentTime, 1000);
      
      // Check for tests that should auto-start
      checkAutoStartTests();
      autoStartCheckInterval = setInterval(checkAutoStartTests, 60000); // Check every minute
      
      // Check for scheduled tests
      updateTestScheduleInfo();
      testScheduleInterval = setInterval(updateTestScheduleInfo, 1000);
      
      // Confirmation modal setup
      document.getElementById('confirmActionBtn').addEventListener('click', function() {
        document.getElementById('confirmationModal').style.display = 'none';
        if (typeof window.confirmCallback === 'function') {
          window.confirmCallback();
        }
      });
      
      document.getElementById('cancelActionBtn').addEventListener('click', function() {
        document.getElementById('confirmationModal').style.display = 'none';
      });
    });
    
    // Performance optimizations
    function debounceFilterTests() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(filterTests, DEBOUNCE_DELAY);
    }
    
    function toggleDarkMode() {
      const body = document.body;
      body.classList.toggle('dark-mode');
      
      const isDarkMode = body.classList.contains('dark-mode');
      localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
      document.getElementById('darkModeToggle').textContent = isDarkMode ? '🌞' : '🌓';
    }
    
    function showAdminView() {
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('studentView').style.display = 'none';
      document.getElementById('adminViewBtn').style.backgroundColor = '#495057';
      document.getElementById('studentViewBtn').style.backgroundColor = '#6c757d';
    }
    
    function showStudentView() {
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('studentView').style.display = 'block';
      document.getElementById('adminViewBtn').style.backgroundColor = '#6c757d';
      document.getElementById('studentViewBtn').style.backgroundColor = '#495057';
      
      // Hide admin view button when test is active
      if (testActive) {
        document.getElementById('adminViewBtn').style.display = 'none';
      } else {
        document.getElementById('adminViewBtn').style.display = 'flex';
      }
    }
    
    function authenticateAdmin() {
      const password = document.getElementById('adminPassword').value;
      if (password === ADMIN_PASSWORD) {
        isAdminLoggedIn = true;
        document.getElementById('adminControls').style.display = 'block';
        document.getElementById('adminLoginForm').style.display = 'none';
        document.getElementById('adminMainControls').style.display = 'block';
        document.getElementById('adminPassword').style.borderColor = '#28a745';
        document.getElementById('adminPassword').value = '';
        showAlert("Admin login successful!", "success");
      } else {
        showAlert("Incorrect admin password!");
        document.getElementById('adminPassword').style.borderColor = '#dc3545';
      }
    }
    
    function adminLogout() {
      isAdminLoggedIn = false;
      document.getElementById('adminControls').style.display = 'none';
      document.getElementById('adminLoginForm').style.display = 'block';
      document.getElementById('adminMainControls').style.display = 'none';
      document.getElementById('adminPassword').style.borderColor = 'var(--border-color)';
      showAlert("Admin logged out successfully.", "success");
    }
    
    function showAddTestForm() {
      document.getElementById('addTestForm').style.display = 'block';
      resetTestForm();
    }
    
    function resetTestForm() {
      document.getElementById('adminStudentName').value = '';
      document.getElementById('adminRollNumber').value = '';
      document.getElementById('adminClassName').value = '';
      document.getElementById('adminStudentEmail').value = '';
      document.getElementById('adminTestPassword').value = '';
      document.getElementById('adminDuration').value = '30';
      document.getElementById('adminPaperInput').value = '';
      
      const now = new Date();
      const oneHourLater = new Date(now.getTime() + 60 * 60 * 1000);
      document.getElementById('adminTestStartTime').value = now.toISOString().slice(0, 16);
      document.getElementById('adminTestEndTime').value = oneHourLater.toISOString().slice(0, 16);
    }
    
    function addStudentTest() {
      const studentName = document.getElementById('adminStudentName').value.trim();
      const rollNumber = document.getElementById('adminRollNumber').value.trim();
      const className = document.getElementById('adminClassName').value.trim();
      const email = document.getElementById('adminStudentEmail').value.trim();
      const password = document.getElementById('adminTestPassword').value;
      const duration = parseInt(document.getElementById('adminDuration').value);
      const testContent = document.getElementById('adminPaperInput').value.trim();
      const startTime = document.getElementById('adminTestStartTime').value;
      const endTime = document.getElementById('adminTestEndTime').value;
      
      if (!studentName || !rollNumber || !password || !testContent) {
        showAlert("Please fill all required fields!");
        return;
      }
      
      if (duration < 1 || duration > 180 || isNaN(duration)) {
        showAlert("Please enter a valid duration between 1 and 180 minutes");
        return;
      }
      
      // Check if roll number already exists
      if (studentTests.some(test => test.rollNumber === rollNumber)) {
        showConfirmation(
          "Overwrite Test",
          "A test already exists for this roll number. Do you want to overwrite it?",
          function() {
            // Remove existing test
            studentTests = studentTests.filter(test => test.rollNumber !== rollNumber);
            saveStudentTest(studentName, rollNumber, className, email, password, duration, testContent, startTime, endTime);
          }
        );
        return;
      }
      
      saveStudentTest(studentName, rollNumber, className, email, password, duration, testContent, startTime, endTime);
    }
    
    function saveStudentTest(studentName, rollNumber, className, email, password, duration, testContent, startTime, endTime) {
      const studentTest = {
        id: Date.now(),
        studentName,
        rollNumber,
        className,
        email,
        password,
        duration,
        testContent,
        startTime,
        endTime,
        createdAt: new Date().toISOString(),
        status: startTime ? getTestStatus(new Date(startTime), new Date(endTime)) : 'active'
      };
      
      studentTests.push(studentTest);
      saveStudentTests();
      updateStudentList();
      resetTestForm();
      
      showAlert("Student test added successfully!", "success");
    }
    
    function getTestStatus(startTime, endTime) {
      const now = new Date();
      if (now < startTime) return 'scheduled';
      if (now > endTime) return 'completed';
      return 'active';
    }
    
    function updateStudentList() {
      const studentList = document.getElementById('studentList');
      studentList.innerHTML = '';
      
      if (studentTests.length === 0) {
        studentList.innerHTML = '<p>No student tests added yet.</p>';
        return;
      }
      
      // Sort tests by status (active first, then scheduled, then completed)
      const sortedTests = [...studentTests].sort((a, b) => {
        const statusOrder = {active: 1, scheduled: 2, completed: 3, expired: 4};
        return statusOrder[a.status] - statusOrder[b.status];
      });
      
      sortedTests.forEach(test => {
        const studentItem = document.createElement('div');
        studentItem.className = 'student-item';
        
        // Update test status based on current time
        if (test.startTime && test.endTime) {
          test.status = getTestStatus(new Date(test.startTime), new Date(test.endTime));
        }
        
        studentItem.innerHTML = `
          <div>
            <strong>${test.studentName}</strong> (${test.rollNumber})<br>
            <small>Class: ${test.className || 'N/A'} | Duration: ${test.duration} mins</small>
            <span class="test-status status-${test.status}">${test.status}</span>
          </div>
          <div>
            <button onclick="viewTestDetails(${test.id})">View</button>
            <button onclick="editStudentTest(${test.id})">Edit</button>
            <button onclick="showDeleteConfirmation(${test.id})" style="background-color: var(--danger-color); color: white;">Delete</button>
          </div>
        `;
        studentList.appendChild(studentItem);
      });
      
      // Update test schedule info if we're in student view
      if (document.getElementById('studentView').style.display === 'block') {
        updateTestScheduleInfo();
      }
    }
    
    function viewTestDetails(id) {
      const test = studentTests.find(t => t.id === id);
      if (!test) return;
      
      const modal = document.getElementById('testDetailsModal');
      const detailsDiv = document.getElementById('modalTestDetails');
      
      // Format dates
      const startDate = test.startTime ? new Date(test.startTime).toLocaleString() : 'Not scheduled';
      const endDate = test.endTime ? new Date(test.endTime).toLocaleString() : 'Not scheduled';
      const createdDate = new Date(test.createdAt).toLocaleString();
      
      detailsDiv.innerHTML = `
        <p><strong>Student Name:</strong> ${test.studentName}</p>
        <p><strong>Roll Number:</strong> ${test.rollNumber}</p>
        <p><strong>Class:</strong> ${test.className || 'N/A'}</p>
        <p><strong>Email:</strong> ${test.email || 'N/A'}</p>
        <p><strong>Test Duration:</strong> ${test.duration} minutes</p>
        <p><strong>Start Time:</strong> ${startDate}</p>
        <p><strong>End Time:</strong> ${endDate}</p>
        <p><strong>Status:</strong> <span class="test-status status-${test.status}">${test.status}</span></p>
        <p><strong>Created At:</strong> ${createdDate}</p>
        <p><strong>Test Password:</strong> ${'•'.repeat(test.password.length)}</p>
        <button class="copy-btn" onclick="copyTestContent(${test.id})">Copy Content</button>
      `;
      
      modal.style.display = 'block';
    }
    
    function copyTestContent(id) {
      const test = studentTests.find(t => t.id === id);
      if (!test) return;
      
      navigator.clipboard.writeText(test.testContent)
        .then(() => showAlert("Test content copied to clipboard!", "success"))
        .catch(err => showAlert("Failed to copy content: " + err));
    }
    
    function closeModal() {
      document.getElementById('testDetailsModal').style.display = 'none';
    }
    
    function editStudentTest(id) {
      const test = studentTests.find(t => t.id === id);
      if (!test) return;
      
      document.getElementById('adminStudentName').value = test.studentName;
      document.getElementById('adminRollNumber').value = test.rollNumber;
      document.getElementById('adminClassName').value = test.className;
      document.getElementById('adminStudentEmail').value = test.email;
      document.getElementById('adminTestPassword').value = test.password;
      document.getElementById('adminDuration').value = test.duration;
      document.getElementById('adminPaperInput').value = test.testContent;
      document.getElementById('adminTestStartTime').value = test.startTime ? test.startTime.slice(0, 16) : '';
      document.getElementById('adminTestEndTime').value = test.endTime ? test.endTime.slice(0, 16) : '';
      
      // Scroll to form
      document.getElementById('addTestForm').scrollIntoView({ behavior: 'smooth' });
      
      // Remove the old test
      studentTests = studentTests.filter(t => t.id !== id);
      saveStudentTests();
      updateStudentList();
      
      showAlert("Test loaded for editing. Make changes and click Save.", "success");
    }
    
    function showDeleteConfirmation(id) {
      showConfirmation(
        "Delete Test",
        "Are you sure you want to delete this student test?",
        function() {
          deleteStudentTest(id);
        }
      );
    }
    
    function deleteStudentTest(id) {
      studentTests = studentTests.filter(test => test.id !== id);
      saveStudentTests();
      updateStudentList();
      showAlert("Test deleted successfully!", "success");
    }
    
    function filterTests() {
      const searchTerm = document.getElementById('searchTests').value.toLowerCase();
      const studentItems = document.querySelectorAll('.student-item');
      
      studentItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    function clearSearch() {
      document.getElementById('searchTests').value = '';
      filterTests();
    }
    
    function saveStudentTests() {
      localStorage.setItem('studentTests', JSON.stringify(studentTests));
    }
    
    function updateTestHistory() {
      const historyDiv = document.getElementById('testHistory');
      historyDiv.innerHTML = '';
      
      if (testHistory.length === 0) {
        historyDiv.innerHTML = '<p>No test history available yet.</p>';
        return;
      }
      
      // Sort by most recent first
      const sortedHistory = [...testHistory].sort((a, b) => new Date(b.endTime) - new Date(a.endTime));
      
      sortedHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        
        const duration = Math.round((new Date(item.endTime) - new Date(item.startTime)) / 60000);
        const endDate = new Date(item.endTime).toLocaleString();
        
        historyItem.innerHTML = `
          <h4>${item.studentName} (${item.rollNumber})</h4>
          <div class="history-meta">
            <span>Completed: ${endDate}</span>
            <span>Duration: ${duration} mins</span>
          </div>
          <p>Status: ${item.status}</p>
        `;
        
        historyDiv.appendChild(historyItem);
      });
    }
    
    function addTestHistory(test, status) {
      const historyItem = {
        studentName: test.studentName,
        rollNumber: test.rollNumber,
        className: test.className,
        startTime: startTime.toISOString(),
        endTime: new Date().toISOString(),
        duration: test.duration,
        status: status,
        tabSwitches: tabSwitchCount
      };
      
      testHistory.unshift(historyItem);
      if (testHistory.length > 50) {
        testHistory.pop(); // Keep only the 50 most recent entries
      }
      
      localStorage.setItem('testHistory', JSON.stringify(testHistory));
      updateTestHistory();
    }
    
    function playAlertSound() {
      const sound = document.getElementById('alertSound');
      sound.currentTime = 0;
      sound.play().catch(e => console.log("Audio play failed:", e));
    }
    
    function playWarningSound() {
      const sound = document.getElementById('warningSound');
      sound.currentTime = 0;
      sound.play().catch(e => console.log("Audio play failed:", e));
    }
    
    function updateTestScheduleInfo() {
      const password = document.getElementById('studentTestPassword').value;
      const test = studentTests.find(t => t.password === password);
      const infoDiv = document.getElementById('testScheduleInfo');
      
      if (!test || !test.startTime || !test.endTime) {
        infoDiv.style.display = 'none';
        return;
      }
      
      const now = new Date();
      const startTime = new Date(test.startTime);
      const endTime = new Date(test.endTime);
      
      // Update test status
      test.status = getTestStatus(startTime, endTime);
      
      infoDiv.style.display = 'block';
      infoDiv.className = `test-schedule-info ${test.status}`;
      
      if (now < startTime) {
        // Test is scheduled for future
        const timeDiff = startTime - now;
        const hoursLeft = Math.floor(timeDiff / (1000 * 60 * 60));
        const minutesLeft = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
        const secondsLeft = Math.floor((timeDiff % (1000 * 60)) / 1000 );
        
        infoDiv.innerHTML = `
          <strong>Test Scheduled</strong><br>
          Starts in: ${hoursLeft}h ${minutesLeft}m ${secondsLeft}s<br>
          Start Time: ${startTime.toLocaleString()}<br>
          End Time: ${endTime.toLocaleString()}
        `;
      } else if (now > endTime) {
        // Test has ended
        infoDiv.innerHTML = `
          <strong>Test Completed</strong><br>
          The test time has ended at ${endTime.toLocaleString()}
        `;
      } else {
        // Test is active
        infoDiv.innerHTML = `
          <strong>Test Active</strong><br>
          Ends at: ${endTime.toLocaleString()}<br>
          ${test.duration} minutes duration
        `;
        
        // If password is entered but test not started, show start button
        if (password && !testActive) {
          document.getElementById('studentStartBtn').style.display = 'flex';
        }
      }
    }
    
    function checkAutoStartTests() {
      const now = new Date();
      const passwordInput = document.getElementById('studentTestPassword');
      
      // Check if we're already in the student view with a test running
      if (document.getElementById('studentView').style.display === 'block' && testActive) {
        return;
      }
      
      // Find tests that should be active now
      const activeTests = studentTests.filter(test => {
        if (!test.startTime || !test.endTime) return false;
        
        const start = new Date(test.startTime);
        const end = new Date(test.endTime);
        
        // Test should be active if current time is between start and end
        return now >= start && now <= end;
      });
      
      // If there's exactly one active test, auto-fill and start it
      if (activeTests.length === 1) {
        const test = activeTests[0];
        passwordInput.value = test.password;
        startStudentTest();
      }
    }
    
    function startStudentTest() {
      const password = document.getElementById('studentTestPassword').value;
      const test = studentTests.find(t => t.password === password);
      
      if (!test) {
        showAlert("Invalid test password!");
        return;
      }
      
      currentTest = test;
      
      // Check test schedule if set
      if (test.startTime && test.endTime) {
        const now = new Date();
        testStartTime = new Date(test.startTime);
        testEndTime = new Date(test.endTime);
        
        if (now < testStartTime) {
          showAlert(`Test cannot be started before ${testStartTime.toLocaleString()}`);
          return;
        }
        
        if (now > testEndTime) {
          showAlert(`Test time has ended at ${testEndTime.toLocaleString()}`);
          return;
        }
      }
      
      // Show loading spinner
      document.getElementById('loadingSpinner').style.display = 'flex';
      
      // Use setTimeout to allow UI to update before heavy operations
      setTimeout(() => {
        try {
          // Hide admin view button
          document.getElementById('adminViewBtn').style.display = 'none';
          
          document.getElementById('testContent').innerText = test.testContent;
          document.getElementById('testWindow').style.display = 'block';
          document.querySelector('#studentView .form-section').style.display = 'none';
          document.getElementById('submitBtn').style.display = 'flex';
          
          // Display student info
          document.getElementById('studentInfoDisplay').innerHTML = `
            <strong>👤 ${test.studentName}</strong> | 
            <strong>🎫 ${test.rollNumber}</strong> | 
            <strong>🏫 ${test.className || 'N/A'}</strong>
          `;
          
          // Enter fullscreen
          const elem = document.documentElement;
          if (elem.requestFullscreen) {
            elem.requestFullscreen().catch(err => {
              showAlert(`Fullscreen error: ${err.message}`);
            });
          } else if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen();
          } else if (elem.msRequestFullscreen) {
            elem.msRequestFullscreen();
          }
          
          testActive = true;
          startTime = new Date();
          totalTime = test.duration * 60;
          timeLeft = totalTime;
          updateTimerDisplay(timeLeft);
          updateCurrentTime();
          updateProgressBar();
          
          countdown = setInterval(() => {
            timeLeft--;
            updateTimerDisplay(timeLeft);
            updateCurrentTime();
            updateProgressBar();
            
            if (timeLeft <= 0) {
              endTest("⏰ Time's Up! Test has been automatically submitted.", true);
            }
          }, 1000);
          
          // Set up visibility change detection
          document.addEventListener('visibilitychange', handleVisibilityChange);
          window.addEventListener('blur', handleWindowBlur);
          document.addEventListener('fullscreenchange', checkFullscreenExit);
          document.addEventListener('webkitfullscreenchange', checkFullscreenExit);
          document.addEventListener('mozfullscreenchange', checkFullscreenExit);
          document.addEventListener('MSFullscreenChange', checkFullscreenExit);
          
          // Check test schedule if set
          if (testStartTime && testEndTime) {
            scheduleCheckInterval = setInterval(() => {
              const now = new Date();
              if (now > testEndTime) {
                endTest("⏰ Scheduled test time has ended. Test auto-submitted.", true);
              }
            }, 60000); // Check every minute
          }
          
          // Disable right-click to prevent copy-paste
          document.addEventListener('contextmenu', preventRightClick);
          
          // Disable keyboard shortcuts
          document.addEventListener('keydown', preventShortcuts);
          
          showAlert("Test started successfully!", "success");
        } catch (error) {
          console.error("Error starting test:", error);
          showAlert("Error starting test: " + error.message);
        } finally {
          // Hide loading spinner
          document.getElementById('loadingSpinner').style.display = 'none';
        }
      }, 100);
    }
    
    function preventRightClick(e) {
      if (testActive) {
        e.preventDefault();
        showWarning("Right-click is disabled during the test.");
      }
    }
    
    function preventShortcuts(e) {
      if (testActive) {
        // Disable F5, F11, F12, Ctrl+R, Ctrl+Shift+R, Ctrl+W, Alt+Tab, etc.
        const forbiddenKeys = [116, 122, 123]; // F5, F11, F12
        const forbiddenCombos = [
          e.ctrlKey && e.keyCode === 82,  // Ctrl+R
          e.ctrlKey && e.keyCode === 87,  // Ctrl+W
          e.altKey && e.keyCode === 9,    // Alt+Tab
          e.ctrlKey && e.shiftKey && e.keyCode === 82 // Ctrl+Shift+R
        ];
        
        if (forbiddenKeys.includes(e.keyCode) || forbiddenCombos.some(combo => combo)) {
          e.preventDefault();
          showWarning("This keyboard shortcut is disabled during the test.");
        }
      }
    }
    
    function showSubmitConfirmation() {
      showConfirmation(
        "Submit Test",
        "Are you sure you want to submit the test now?",
        function() {
          endTest("✅ Test submitted successfully!", true);
        }
      );
    }
    
    function handleVisibilityChange() {
      if (document.hidden && testActive) {
        tabSwitchCount++;
        if (tabSwitchCount >= MAX_TAB_SWITCHES) {
          endTest(`🚫 Test auto-submitted. You switched tabs/windows ${MAX_TAB_SWITCHES} times.`, true);
        } else {
          const remainingSwitches = MAX_TAB_SWITCHES - tabSwitchCount;
          const warningMsg = 
            `Warning: You switched tabs/windows (${tabSwitchCount}/${MAX_TAB_SWITCHES}). ${remainingSwitches} more attempts allowed.`;
          document.getElementById('fsWarning').innerText = warningMsg;
          showWarning(warningMsg);
          playWarningSound();
        }
      }
    }
    
    function handleWindowBlur() {
      if (testActive) {
        document.getElementById('fsWarning').innerText = 
          "Warning: The test window lost focus. Don't switch applications!";
      }
    }
    
    function updateTimerDisplay(seconds) {
      const min = Math.floor(seconds / 60);
      const sec = seconds % 60;
      document.getElementById('timer').innerHTML = 
        `<span>⏱ Time Left:</span> <span style="font-size:1.2em">${min}:${sec < 10 ? '0' : ''}${sec}</span>`;
    }
    
    function updateProgressBar() {
      const progressPercent = (timeLeft / totalTime) * 100;
      document.getElementById('progressBar').style.width = `${progressPercent}%`;
      
      // Change color based on remaining time
      if (progressPercent < 20) {
        document.getElementById('progressBar').style.backgroundColor = 'var(--danger-color)';
      } else if (progressPercent < 50) {
        document.getElementById('progressBar').style.backgroundColor = 'var(--warning-color)';
      }
    }
    
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString();
      document.getElementById('currentTime').innerHTML = 
        `<span>🕒 Current Time:</span> <span style="font-size:1.1em">${timeString}</span>`;
    }
    
    function checkFullscreenExit() {
      if (!isFullscreen() && testActive) {
        endTest("🚫 Test auto-submitted because you exited full screen mode.", true);
      }
    }
    
    function isFullscreen() {
      return !!(document.fullscreenElement || 
               document.webkitFullscreenElement || 
               document.mozFullScreenElement || 
               document.msFullscreenElement);
    }
    
    function endTest(message, playSound = false) {
      clearInterval(countdown);
      clearInterval(scheduleCheckInterval);
      testActive = false;
      
      if (playSound) {
        playAlertSound();
      }
      
      // Calculate time taken
      const endTime = new Date();
      const timeTaken = Math.round((endTime - startTime) / 1000);
      const minutesTaken = Math.floor(timeTaken / 60);
      const secondsTaken = timeTaken % 60;
      
      // Add to test history
      if (currentTest) {
        const status = message.includes("auto-submitted") ? "Auto-submitted" : "Completed";
        addTestHistory(currentTest, status);
      }
      
      document.getElementById('testWindow').innerHTML = `
        <h2>${message}</h2>
        <div style="text-align: center; margin-top: 20px; font-size: 18px;">
          <p>Time taken: ${minutesTaken}m ${secondsTaken}s</p>
          <p>Tab/window switches: ${tabSwitchCount}</p>
          <button onclick="resetStudentView()" style="margin-top: 20px;">Return to Test Login</button>
        </div>
      `;
      
      exitFullscreen();
      cleanupEventListeners();
    }
    
    function resetStudentView() {
      // Clear any existing intervals
      clearInterval(countdown);
      clearInterval(scheduleCheckInterval);
      
      // Reset variables
      testActive = false;
      timeLeft = 0;
      tabSwitchCount = 0;
      testStartTime = null;
      testEndTime = null;
      currentTest = null;
      
      // Reset form
      document.getElementById('studentTestPassword').value = '';
      
      // Show login form
      document.querySelector('#studentView .form-section').style.display = 'block';
      document.getElementById('testWindow').style.display = 'none';
      document.getElementById('submitBtn').style.display = 'none';
      document.getElementById('testScheduleInfo').style.display = 'none';
      
      // Reset progress bar
      document.getElementById('progressBar').style.width = '100%';
      document.getElementById('progressBar').style.backgroundColor = 'var(--success-color)';
      
      // Show admin view button again
      document.getElementById('adminViewBtn').style.display = 'flex';
      
      // Exit fullscreen if still in it
      exitFullscreen();
      cleanupEventListeners();
    }
    
    function exitFullscreen() {
      if (document.exitFullscreen) {
        document.exitFullscreen();
      } else if (document.webkitExitFullscreen) {
        document.webkitExitFullscreen();
      } else if (document.msExitFullscreen) {
        document.msExitFullscreen();
      }
    }
    
    function cleanupEventListeners() {
      document.removeEventListener('visibilitychange', handleVisibilityChange);
      window.removeEventListener('blur', handleWindowBlur);
      document.removeEventListener('fullscreenchange', checkFullscreenExit);
      document.removeEventListener('webkitfullscreenchange', checkFullscreenExit);
      document.removeEventListener('mozfullscreenchange', checkFullscreenExit);
      document.removeEventListener('MSFullscreenChange', checkFullscreenExit);
      document.removeEventListener('contextmenu', preventRightClick);
      document.removeEventListener('keydown', preventShortcuts);
    }
    
    function showAlert(message, type = 'error') {
      // Remove any existing alerts
      const existingAlerts = document.querySelectorAll('.alert');
      existingAlerts.forEach(alert => alert.remove());
      
      // Create alert element
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.textContent = message;
      document.body.appendChild(alertDiv);
      
      // Remove after 3 seconds
      setTimeout(() => {
        alertDiv.style.transition = 'opacity 0.5s';
        alertDiv.style.opacity = '0';
        setTimeout(() => {
          document.body.removeChild(alertDiv);
        }, 500);
      }, 3000);
    }
    
    function showWarning(message) {
      const warningBox = document.createElement('div');
      warningBox.className = 'warning-box';
      warningBox.textContent = message;
      
      // Insert at the top of the test window
      const testWindow = document.getElementById('testWindow');
      if (testWindow) {
        testWindow.insertBefore(warningBox, testWindow.firstChild);
        
        // Remove after 5 seconds
        setTimeout(() => {
          warningBox.style.transition = 'opacity 0.5s';
          warningBox.style.opacity = '0';
          setTimeout(() => {
            warningBox.remove();
          }, 500);
        }, 5000);
      }
    }
    
    function showConfirmation(title, message, callback) {
      document.getElementById('confirmationTitle').textContent = title;
      document.getElementById('confirmationMessage').textContent = message;
      document.getElementById('confirmationModal').style.display = 'block';
      window.confirmCallback = callback;
    }
    
    function importTestData() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      
      input.onchange = e => {
        const file = e.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = event => {
          try {
            const data = JSON.parse(event.target.result);
            if (Array.isArray(data)) {
              studentTests = data;
              saveStudentTests();
              updateStudentList();
              showAlert("Tests imported successfully!", "success");
            } else {
              showAlert("Invalid file format. Expected array of tests.");
            }
          } catch (error) {
            showAlert("Error parsing file: " + error.message);
          }
        };
        reader.readAsText(file);
      };
      
      input.click();
    }
    
    function exportTestData() {
      const dataStr = JSON.stringify(studentTests, null, 2);
      const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
      
      const exportName = 'student-tests_' + new Date().toISOString().slice(0, 10) + '.json';
      
      const linkElement = document.createElement('a');
      linkElement.setAttribute('href', dataUri);
      linkElement.setAttribute('download', exportName);
      linkElement.click();
      
      showAlert("Tests exported successfully!", "success");
    }
    
    function generateRandomTest() {
      const names = ["Alex Johnson", "Maria Garcia", "James Smith", "Sarah Williams", "Robert Brown"];
      const classes = ["CS101", "MATH202", "PHYS101", "ENG301", "BIO201"];
      
      const randomName = names[Math.floor(Math.random() * names.length)];
      const randomClass = classes[Math.floor(Math.random() * classes.length)];
      const randomRoll = "R" + Math.floor(1000 + Math.random() * 9000);
      
      document.getElementById('adminStudentName').value = randomName;
      document.getElementById('adminRollNumber').value = randomRoll;
      document.getElementById('adminClassName').value = randomClass;
      document.getElementById('adminStudentEmail').value = randomName.toLowerCase().replace(" ", ".") + "@university.edu";
      document.getElementById('adminTestPassword').value = Math.random().toString(36).substring(2, 8);
      
      const now = new Date();
      const startTime = new Date(now.getTime() + Math.floor(Math.random() * 7) * 24 * 60 * 60 * 1000);
      const endTime = new Date(startTime.getTime() + 60 * 60 * 1000);
      
      document.getElementById('adminTestStartTime').value = startTime.toISOString().slice(0, 16);
      document.getElementById('adminTestEndTime').value = endTime.toISOString().slice(0, 16);
      document.getElementById('adminDuration').value = 30 + Math.floor(Math.random() * 60);
      
      const questions = [
        "Explain the main concepts covered in this course.",
        "Solve the following problem and show your work.",
        "Compare and contrast the two approaches we discussed.",
        "Describe the significance of this theory in modern applications.",
        "Provide examples that demonstrate this principle."
      ];
      
      let testContent = "";
      for (let i = 1; i <= 5; i++) {
        testContent += `Question ${i}: ${questions[Math.floor(Math.random() * questions.length)]}\n\n`;
      }
      
      document.getElementById('adminPaperInput').value = testContent;
      
      showAlert("Random test generated. Review and save.", "success");
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
      const modal = document.getElementById('testDetailsModal');
      if (event.target == modal) {
        closeModal();
      }
      
      const confirmationModal = document.getElementById('confirmationModal');
      if (event.target == confirmationModal) {
        confirmationModal.style.display = 'none';
      }
    }
  </script>
</body>
</html>